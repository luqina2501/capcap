---
import { supabase } from "../db/supabase";
import "../styles/global.css";

// Enums
const PAGE_TYPES = [
  "cover",
  "title_page",
  "toc",
  "content",
  "exercise",
  "blank",
  "other",
];
const OBJECTS_PRESENT_ENUM = [
  "person_child",
  "person_adult",
  "student",
  "teacher",
  "animal_generic",
  "animal_pet",
  "animal_farm",
  "animal_wild",
  "food_fruit",
  "food_vegetable",
  "food_bundle",
  "book",
  "notebook",
  "pen",
  "pencil",
  "school_bag",
  "clock_analog",
  "clock_digital",
  "countable_object",
  "grouped_object",
  "table",
  "chart",
  "illustration_scene",
];
const ERROR_TAGS = [
  "OCR_MISSING",
  "OCR_WRONG",
  "OCR_UNREADABLE",
  "OCR_NOT_CONTEXTUALIZED",
  "HALLUCINATION",
  "WRONG_LAYOUT",
  "SUBJECTIVE_REASONING",
  "TOO_LONG_SHORT",
  "DETAIL_INCOHERENT_FLOW",
  "MISQUOTED_TEXT",
  "COUNTING_WRONG",
  "CLOCK_READING_WRONG",
  "ID_ISSUE",
  "IMAGE_MISMATCH",
];

const REVIEW_PRIORITY_ENUM = ["low", "normal", "high"];
const IS_CHECKED_ENUM = ["unchecked", "checked", "reviewed"];

const PREFIXES = [
  "SGK_CanhDieu_DaoDuc_1",
  "SGK_CanhDieu_DaoDuc_2",
  "SGK_CanhDieu_DaoDuc_3",

  "SGK_CanhDieu_TiengViet_2_Tap1",
  "SGK_CanhDieu_TiengViet_2_Tap2",

  "SGK_CanhDieu_Toan_1",
  "SGK_CanhDieu_Toan_3_Tap1",

  "SGK_CanhDieu_TuNhienVaXaHoi_1",
  "SGK_CanhDieu_TuNhienVaXaHoi_2",
  "SGK_CanhDieu_TuNhienVaXaHoi_3",
];

let message = "";
let finished = false;
let totalCount = 0;
let checkedCount = 0;
const isSaved = new URL(Astro.request.url).searchParams.get("saved") === "true";

if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const id = formData.get("id");

    // Check if we are just saving or saving & continuing (not strictly needed if we just reload)
    // But let's handle the data update first.

    const page_type = formData.get("page_type");
    const has_text = formData.has("has_text"); // Checkbox logic: strictly this might need review if UI sends "yes"/"no" from dropdown
    // Requirement says dropdown True/False. If it's a select with value "true"/"false", formData.get() returns string.
    // If it is a checkbox, formData.has() works.
    // The UI implementation plan says dropdown. Let's assume standard form behavior.
    // I will adjust UI to send "true"/"false" strings or boolean-like values.

    // Actually, let's look at the UI implementation plan again.
    // "dropdown(True/False) to has_text"
    const has_text_val = formData.get("has_text");
    const has_table_val = formData.get("has_table");

    const objects_present = formData.getAll("objects_present");
    const error_tags = formData.getAll("error_tags");
    const notes = formData.get("notes");
    const change_log = formData.get("change_log");

    const caption_short = formData.get("caption_short");
    const caption_detail = formData.get("caption_detail");
    const text_in_image = formData.get("text_in_image"); // verification

    const { error: updateError } = await supabase
      .from("dataset")
      .update({
        page_type,
        has_text: has_text_val === "true" || has_text_val === "on",
        has_table: has_table_val === "true" || has_table_val === "on",
        objects_present,
        error_tags,
        notes: notes ? notes : null,
        change_log: change_log ? change_log : null,
        caption_short: caption_short ? caption_short : null,
        caption_detail: caption_detail ? caption_detail : null,
        text_in_image: text_in_image ? text_in_image : null,
        is_checked: "checked", // Enum value
      })
      .eq("id", id);

    if (updateError) {
      console.error("Update Error:", updateError);
      message = "Error updating row: " + updateError.message;
    } else {
      console.log("Updated successful:", id);
      return Astro.redirect(`/?search_id=${id}&saved=true`);
    }
  } catch (e) {
    console.error("Submission error:", e);
    message = "Server error processing request.";
  }
}

// --- Filter Logic ---
const cookieHeader = Astro.request.headers.get("cookie") || "";
// Simple cookie parser
const getCookie = (name: string) => {
  const value = `; ${cookieHeader}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop()?.split(";").shift();
  return null;
};

const filterCookie = getCookie("dataset_filter");
let activeFilters = PREFIXES; // Default to all
if (filterCookie) {
  try {
    const parsed = JSON.parse(decodeURIComponent(filterCookie));
    if (Array.isArray(parsed) && parsed.length > 0) {
      activeFilters = parsed;
    }
  } catch (e) {
    console.error("Error parsing filter cookie", e);
  }
}

// Additional Filters (Requirement 3: Search, Review Priority, Is Checked)
// We'll implemented basic handling here.
// Ideally we should have a comprehensive filter state, but for now let's focus on the random fetch.
// If the user performed a search (e.g. via GET param `search_id`), prioritize that.
const url = new URL(Astro.request.url);
const searchId = url.searchParams.get("search_id");
const filterIsChecked =
  url.searchParams.get("filter_is_checked") || "unchecked"; // unchecked, checked, reviewed, all
const filterPriority = url.searchParams.get("filter_priority"); // low, normal, high, or null (all)

let dataRow = null;

if (!finished) {
  if (searchId) {
    const { data } = await supabase
      .from("dataset")
      .select("*")
      .eq("id", searchId)
      .single();
    if (data) dataRow = data;
  } else {
    // Weighted Random Selection: High(50%), Normal(33%), Low(17%)
    const rand = Math.random();
    let priorityTarget = "normal";
    if (rand < 0.5) priorityTarget = "high";
    else if (rand < 0.83) priorityTarget = "normal";
    else priorityTarget = "low";

    // If we filter by specific priority from UI, override this
    if (filterPriority) priorityTarget = filterPriority;

    // Helper to build query
    const buildQuery = (prio: string) => {
      let query = supabase
        .from("dataset")
        .select("*")
        .eq("review_priority", prio);

      if (filterIsChecked !== "all") {
        query = query.eq("is_checked", filterIsChecked);
      }

      // Prefix filters
      const filterQuery = activeFilters.map((p) => `id.like.${p}%`).join(",");
      if (filterQuery) {
        query = query.or(filterQuery);
      }
      return query;
    };

    // Try fetching with target priority
    let { data } = await buildQuery(priorityTarget).limit(50);

    // If no data found for this priority, fallback to others?
    // The requirement implies strictly weighted, but users usually want *some* data.
    // Let's try other priorities if data is empty.
    if (!data || data.length === 0) {
      // Try any priority
      let query = supabase.from("dataset").select("*");
      if (filterIsChecked !== "all")
        query = query.eq("is_checked", filterIsChecked);
      const filterQuery = activeFilters.map((p) => `id.like.${p}%`).join(",");
      if (filterQuery) query = query.or(filterQuery);

      const { data: fallbackData } = await query.limit(50);
      if (fallbackData && fallbackData.length > 0) {
        data = fallbackData;
      }
    }

    if (data && data.length) {
      dataRow = data[Math.floor(Math.random() * data.length)];
    }
  }

  // Calculate Progress (Requirement 2)
  // checked / total in filtered prefixes
  totalCount = 0;
  checkedCount = 0;

  // Build filter query string for reuse
  const prefixFilterStr = activeFilters.map((p) => `id.like.${p}%`).join(",");

  let totalQuery = supabase
    .from("dataset")
    .select("*", { count: "exact", head: true });

  let checkedQuery = supabase
    .from("dataset")
    .select("*", { count: "exact", head: true })
    .neq("is_checked", "unchecked"); // "checked" or "reviewed" counts as progress

  if (prefixFilterStr) {
    totalQuery = totalQuery.or(prefixFilterStr);
    checkedQuery = checkedQuery.or(prefixFilterStr);
  }

  const [totalRes, checkedRes] = await Promise.all([totalQuery, checkedQuery]);
  if (totalRes.count !== null) totalCount = totalRes.count;
  if (checkedRes.count !== null) checkedCount = checkedRes.count;

  if (!dataRow && !searchId) {
    if (totalCount > 0 && totalCount === checkedCount) {
      finished = true;
    }
  }
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>Dataset Review</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      ::selection {
        background-color: #cbd5e1;
        color: #0f172a;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
  </head>
  <body
    class="bg-white text-slate-900 font-['Inter'] h-screen overflow-hidden antialiased"
  >
    {
      finished ? (
        <div class="flex flex-col items-center justify-center h-full w-full bg-slate-50">
          <div class="max-w-md text-center space-y-6">
            <h1 class="text-3xl font-bold text-slate-900">All Done</h1>
            <p class="text-slate-500">
              You've successfully reviewed the entire dataset.
            </p>
            <button
              onclick="window.location.reload()"
              class="px-6 py-2 bg-slate-900 text-white font-medium rounded-lg hover:bg-slate-800 transition-colors"
            >
              Check Again
            </button>
          </div>
        </div>
      ) : dataRow ? (
        <div class="flex h-full">
          {/* Left: Image (5/12) */}
          <div class="w-5/12 bg-zinc-900 flex flex-col relative">
            {/* Header / Progress - Now Relative */}
            <div class="flex-none p-4 flex flex-col gap-4 bg-zinc-900 border-b border-white/5 shadow-2xl z-10">
              <div class="flex justify-between items-center">
                 <span class="font-mono text-xs text-zinc-500">ID: {dataRow.id}</span>
                 <span class={`text-[10px] uppercase tracking-wider font-bold px-2 py-1 rounded ${dataRow.review_priority === 'high' ? 'bg-rose-900/50 text-rose-300' : dataRow.review_priority === 'normal' ? 'bg-blue-900/50 text-blue-300' : 'bg-zinc-800 text-zinc-400'}`}>
                    {dataRow.review_priority} Priority
                 </span>
              </div>
              
               <div class="w-full">
                  <div class="flex justify-between items-end mb-1">
                      <span class="text-[10px] uppercase tracking-wider font-bold text-zinc-400">Progress</span>
                      <div class="flex items-center gap-2">
                          <span class="text-xs font-mono text-white/90 font-bold">{checkedCount} / {totalCount}</span>
                          <span class="text-[10px] text-zinc-500 font-mono">({totalCount > 0 ? Math.round((checkedCount / totalCount) * 100) : 0}%)</span>
                      </div>
                  </div>
                  <div class="w-full h-3 bg-zinc-800 rounded-full overflow-hidden">
                     <div class="h-full bg-indigo-500 rounded-full shadow-[0_0_10px_rgba(99,102,241,0.5)] transition-all duration-500" style={`width: ${totalCount > 0 ? (checkedCount / totalCount) * 100 : 0}%`}></div>
                  </div>
              </div>
            </div>
            <div class="flex-1 flex flex-col items-center justify-start p-6 overflow-y-auto">
              <img
                src={`${import.meta.env.SUPABASE_URL}/storage/v1/object/public/images/${dataRow.id}.png`}
                alt="Dataset Image"
                class="w-full h-auto object-contain shadow-2xl mb-6 rounded-lg"
              />

              {/* Captions - Moved out of constrained box, improved typography */}
              <div class="w-full space-y-8 px-2 pb-10">
                 
                 {/* Caption Short */}
                 <div class="group">
                   <div class="flex justify-between items-baseline mb-3">
                        <label class="text-sm font-bold text-zinc-300 uppercase tracking-widest border-l-2 border-indigo-500 pl-3">Caption Short</label>
                        <button type="button" id="btn-edit-caption-short" class="px-3 py-1 text-xs bg-indigo-500/10 text-indigo-400 border border-indigo-500/30 rounded-full hover:bg-indigo-500 hover:text-white transition-all opacity-70 group-hover:opacity-100 flex items-center gap-1" onclick="toggleEditCaption('caption_short_input', 'btn-edit-caption-short')">
                             <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                             <span class="btn-text">Edit</span>
                        </button>
                   </div>
                   <textarea
                     id="caption_short_input"
                     name="caption_short" 
                     form="main-form"
                     rows="3"
                     readonly
                     class="w-full bg-transparent border-0 border-b border-zinc-800 text-lg text-zinc-100 placeholder-zinc-700 focus:ring-0 focus:border-indigo-500 transition-all leading-relaxed resize-none p-0 read-only:cursor-text"
                     placeholder="No short caption..."
                     oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'; document.getElementById('changelog_container').classList.remove('hidden')"
                     onfocus="this.classList.remove('border-zinc-800'); this.classList.add('border-indigo-500')"
                     onblur="this.classList.add('border-zinc-800'); this.classList.remove('border-indigo-500')"
                   >{dataRow.caption_short || ""}</textarea>
                 </div>
                 
                 {/* Caption Detail */}
                 <div class="group">
                    <div class="flex justify-between items-baseline mb-3">
                        <label class="text-sm font-bold text-zinc-300 uppercase tracking-widest border-l-2 border-indigo-500 pl-3">Caption Detail</label>
                        <button type="button" id="btn-edit-caption-detail" class="px-3 py-1 text-xs bg-indigo-500/10 text-indigo-400 border border-indigo-500/30 rounded-full hover:bg-indigo-500 hover:text-white transition-all opacity-70 group-hover:opacity-100 flex items-center gap-1" onclick="toggleEditCaption('caption_detail_input', 'btn-edit-caption-detail')">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                            <span class="btn-text">Edit</span>
                        </button>
                   </div>
                   <textarea
                     id="caption_detail_input"
                     name="caption_detail"
                     form="main-form"
                     rows="8" 
                     readonly
                     class="w-full bg-transparent border-0 border-b border-zinc-800 text-base text-zinc-300 placeholder-zinc-700 focus:ring-0 focus:border-indigo-500 transition-all leading-8 resize-none p-0 read-only:cursor-text"
                     placeholder="No detail caption..."
                      oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'; document.getElementById('changelog_container').classList.remove('hidden')"
                      onfocus="this.classList.remove('border-zinc-800'); this.classList.add('border-indigo-500')"
                      onblur="this.classList.add('border-zinc-800'); this.classList.remove('border-indigo-500')"
                   >{dataRow.caption_detail || ""}</textarea>
                 </div>
              </div>
            </div>
          </div>

          {/* Right: Form (7/12) */}
          <div class="w-7/12 bg-white border-l border-slate-200 flex flex-col relative">
            <div class="px-8 py-5 border-b border-slate-100 flex justify-between items-center bg-white z-20">
              <div class="flex items-baseline space-x-3">
                <h2 class="font-semibold text-slate-900 text-lg">
                  Review Item
                </h2>
                <span class="text-xs text-slate-400 uppercase tracking-widest font-medium">
                  Data Validation
                </span>
              </div>

              {/* Filter Button */}
              <button
                id="filter-btn"
                class="flex items-center space-x-2 text-sm font-medium text-slate-600 hover:text-indigo-600 transition-colors bg-slate-50 hover:bg-indigo-50 px-3 py-1.5 rounded-lg border border-slate-200 hover:border-indigo-200"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
                  />
                </svg>
                <span>
                  Filter Dataset (
                  {activeFilters.length === PREFIXES.length
                    ? "All"
                    : activeFilters.length}
                  )
                </span>
              </button>
            </div>

            {/* Filter Modal */}
            <div
              id="filter-modal"
              class="hidden absolute top-16 right-8 w-80 bg-white shadow-2xl rounded-xl border border-slate-200 z-50 animate-fade-in flex flex-col max-h-[80vh]"
            >
              <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
                <h3 class="font-bold text-slate-700 text-sm">Filter Dataset</h3>
                <button
                  id="close-filter"
                  class="text-slate-400 hover:text-rose-500"
                >
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"
                    />
                  </svg>
                </button>
              </div>

              <div class="overflow-y-auto p-4 space-y-6 flex-1 custom-scrollbar">
                {/* Search */}
                <div class="space-y-2">
                  <label class="text-xs font-bold text-slate-500 uppercase">
                    Search by ID
                  </label>
                  <div class="flex gap-2">
                    <input
                      type="text"
                      id="search-input"
                      placeholder="Enter ID..."
                      class="flex-1 text-xs border-slate-300 rounded shadow-sm focus:border-indigo-500 focus:ring-indigo-200"
                      value={searchId || ""}
                    />
                    <button
                      id="search-btn"
                      class="px-2 py-1 bg-indigo-50 text-indigo-600 rounded border border-indigo-200 text-xs font-bold hover:bg-indigo-100"
                    >
                      Go
                    </button>
                  </div>
                </div>

                {/* Priority */}
                <div class="space-y-2">
                  <label class="text-xs font-bold text-slate-500 uppercase">
                    Review Priority
                  </label>
                  <select
                    id="filter-priority"
                    class="w-full text-xs border-slate-300 rounded shadow-sm focus:border-indigo-500 focus:ring-indigo-200"
                  >
                    <option value="">All Priorities</option>
                    {REVIEW_PRIORITY_ENUM.map((p) => (
                      <option value={p} selected={filterPriority === p}>
                        {p.toUpperCase()}
                      </option>
                    ))}
                  </select>
                </div>

                {/* Status */}
                <div class="space-y-2">
                  <label class="text-xs font-bold text-slate-500 uppercase">
                    Checked Status
                  </label>
                  <select
                    id="filter-is-checked"
                    class="w-full text-xs border-slate-300 rounded shadow-sm focus:border-indigo-500 focus:ring-indigo-200"
                  >
                    <option value="all" selected={filterIsChecked === "all"}>
                      All
                    </option>
                    {IS_CHECKED_ENUM.map((s) => (
                      <option value={s} selected={filterIsChecked === s}>
                        {s.toUpperCase()}
                      </option>
                    ))}
                  </select>
                </div>

                <hr class="border-slate-100" />

                {/* Prefixes */}
                <div class="space-y-2">
                  <div class="flex justify-between items-center">
                    <label class="text-xs font-bold text-slate-500 uppercase">
                      Book Prefix
                    </label>
                    <div class="flex space-x-2 text-[10px]">
                      <button
                        id="select-all"
                        class="text-indigo-600 hover:text-indigo-800"
                      >
                        Select All
                      </button>
                      <button
                        id="clear-all"
                        class="text-slate-500 hover:text-rose-500"
                      >
                        None
                      </button>
                    </div>
                  </div>
                  <div class="space-y-1 max-h-40 overflow-y-auto custom-scrollbar bg-slate-50 p-2 rounded border border-slate-100">
                    {PREFIXES.map((prefix) => (
                      <label class="flex items-start space-x-2 cursor-pointer group p-1 hover:bg-white rounded">
                        <input
                          type="checkbox"
                          name="prefix_filter"
                          value={prefix}
                          checked={activeFilters.includes(prefix)}
                          class="mt-0.5 rounded border-slate-300 text-indigo-600 shadow-sm focus:ring-0 w-3.5 h-3.5"
                        />
                        <span class="text-[11px] text-slate-600 group-hover:text-slate-900 break-all leading-tight">
                          {prefix}
                        </span>
                      </label>
                    ))}
                  </div>
                </div>
              </div>

              <div class="p-4 border-t border-slate-100 bg-slate-50 rounded-b-xl">
                <button
                  id="apply-filter"
                  class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-md transition-all text-sm"
                >
                  Apply Filters
                </button>
              </div>
            </div>

            {message && (
              <div class="mx-8 mt-6 p-4 bg-emerald-50 text-emerald-700 text-sm rounded-lg border border-emerald-100 flex items-center gap-2">
                <svg
                  class="w-5 h-5 flex-shrink-0"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  />
                </svg>
                {message}
              </div>
            )}

            <form
              id="main-form"
              method="POST"
              class="flex-1 overflow-y-auto p-8 space-y-10"
            >
              <input type="hidden" name="id" value={dataRow.id} />

              {/* Questionnaire Section */}
              <div class="space-y-8">
                
                {/* 1. Page Type */}
                <div class="bg-indigo-50/50 p-5 rounded-xl border border-indigo-100 transition-all" id="q-page-type">
                    <div class="flex flex-col gap-3">
                        <h3 class="text-sm font-bold text-indigo-900 uppercase tracking-wide">
                            1. Is this <span class="text-indigo-600">"{dataRow.page_type.replace('_', ' ')}"</span> page?
                        </h3>
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-indigo-100 hover:border-indigo-300 transition-colors shadow-sm">
                                <input type="radio" name="q_page_type" value="yes" class="text-indigo-600 focus:ring-offset-0 focus:ring-0" checked onclick="toggleSection('edit-page-type', false); revealNext('q-has-text')" />
                                <span class="text-sm font-medium text-slate-700">Yes</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-rose-100 hover:border-rose-300 transition-colors shadow-sm">
                                <input type="radio" name="q_page_type" value="no" class="text-rose-500 focus:ring-offset-0 focus:ring-0" onclick="toggleSection('edit-page-type', true); revealNext('q-has-text')" />
                                <span class="text-sm font-medium text-slate-700">No</span>
                            </label>
                        </div>
                        
                        <div id="edit-page-type" class="hidden mt-2 p-3 bg-white rounded-lg border border-indigo-100 animate-fade-in">
                            <label class="block text-xs font-bold text-slate-500 mb-1">Select correct Page Type:</label>
                             <select name="page_type" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5">
                                {PAGE_TYPES.map(t => (
                                    <option value={t} selected={dataRow.page_type === t}>{t.replace('_', ' ')}</option>
                                ))}
                            </select>
                        </div>
                    </div>
                </div>

                {/* 2. Has Text */}
                <div class="bg-slate-50 p-5 rounded-xl border border-slate-200 transition-all opacity-50 pointer-events-none" id="q-has-text">
                     <div class="flex flex-col gap-3">
                        <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wide">
                            2. This page has <span class="text-indigo-600">{dataRow.has_text ? 'TEXT' : 'NO TEXT'}</span>?
                        </h3>
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-slate-200 hover:border-indigo-300 transition-colors shadow-sm">
                                <input type="radio" name="q_has_text" value="yes" class="text-indigo-600 focus:ring-offset-0 focus:ring-0" checked onclick="toggleSection('edit-has-text', false); revealNext('q-has-table')" />
                                <span class="text-sm font-medium text-slate-700">Yes</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-slate-200 hover:border-rose-300 transition-colors shadow-sm">
                                <input type="radio" name="q_has_text" value="no" class="text-rose-500 focus:ring-offset-0 focus:ring-0" onclick="toggleSection('edit-has-text', true); revealNext('q-has-table')" />
                                <span class="text-sm font-medium text-slate-700">No</span>
                            </label>
                        </div>

                         <div id="edit-has-text" class="hidden mt-2 p-3 bg-white rounded-lg border border-slate-200 animate-fade-in">
                             <label class="block text-xs font-bold text-slate-500 mb-1">Override Has Text:</label>
                             <select name="has_text" class="w-full border text-sm rounded-lg block p-2.5 bg-slate-50 border-slate-300 text-slate-900">
                                 <option value="true" selected={dataRow.has_text}>Yes (one or more)</option>
                                 <option value="false" selected={!dataRow.has_text}>No</option>
                            </select>
                         </div>
                     </div>
                </div>

                {/* 3. Has Table */}
                <div class="bg-slate-50 p-5 rounded-xl border border-slate-200 transition-all opacity-50 pointer-events-none" id="q-has-table">
                     <div class="flex flex-col gap-3">
                        <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wide">
                            3. This page has <span class="text-indigo-600">{dataRow.has_table ? 'TABLE' : 'NO TABLE'}</span>?
                        </h3>
                         <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-slate-200 hover:border-indigo-300 transition-colors shadow-sm">
                                <input type="radio" name="q_has_table" value="yes" class="text-indigo-600 focus:ring-offset-0 focus:ring-0" checked onclick="toggleSection('edit-has-table', false); revealNext('q-objects')" />
                                <span class="text-sm font-medium text-slate-700">Yes</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-slate-200 hover:border-rose-300 transition-colors shadow-sm">
                                <input type="radio" name="q_has_table" value="no" class="text-rose-500 focus:ring-offset-0 focus:ring-0" onclick="toggleSection('edit-has-table', true); revealNext('q-objects')" />
                                <span class="text-sm font-medium text-slate-700">No</span>
                            </label>
                        </div>
                        <div id="edit-has-table" class="hidden mt-2 p-3 bg-white rounded-lg border border-slate-200 animate-fade-in">
                             <label class="block text-xs font-bold text-slate-500 mb-1">Override Has Table:</label>
                             <select name="has_table" class="w-full border text-sm rounded-lg block p-2.5 bg-slate-50 border-slate-300 text-slate-900">
                                 <option value="true" selected={dataRow.has_table}>Yes (one or more)</option>
                                 <option value="false" selected={!dataRow.has_table}>No</option>
                            </select>
                         </div>
                     </div>
                </div>

                {/* 4. Objects Present */}
                <div class="bg-slate-50 p-5 rounded-xl border border-slate-200 transition-all opacity-50 pointer-events-none" id="q-objects">
                   <div class="flex flex-col gap-3">
                       <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wide">
                           4. The following objects are present?
                       </h3>
                       <div class="flex flex-wrap gap-2 text-xs font-medium text-slate-600 bg-white p-3 rounded-lg border border-slate-200">
                            {dataRow.objects_present && dataRow.objects_present.length > 0 ? (
                                dataRow.objects_present.map((obj: string) => (<span class="px-2 py-1 bg-indigo-50 text-indigo-700 rounded border border-indigo-100">{obj.replace('_',' ')}</span>))
                            ) : "No objects listed"}
                       </div>
                       
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-slate-200 hover:border-indigo-300 transition-colors shadow-sm">
                                <input type="radio" name="q_objects" value="yes" class="text-indigo-600 focus:ring-offset-0 focus:ring-0" checked onclick="toggleSection('edit-objects', false); revealNext('q-verify')" />
                                <span class="text-sm font-medium text-slate-700">Yes</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-slate-200 hover:border-rose-300 transition-colors shadow-sm">
                                <input type="radio" name="q_objects" value="no" class="text-rose-500 focus:ring-offset-0 focus:ring-0" onclick="toggleSection('edit-objects', true); revealNext('q-verify')" />
                                <span class="text-sm font-medium text-slate-700">No</span>
                            </label>
                        </div>
                   </div>

                   <div id="edit-objects" class="hidden mt-4 pt-4 border-t border-slate-200">
                       <label class="block text-xs font-bold text-slate-900 uppercase tracking-wider mb-2">Check Actual Objects:</label>
                       <div class="grid grid-cols-2 gap-y-2 gap-x-4 max-h-60 overflow-y-auto custom-scrollbar pr-2">
                           {OBJECTS_PRESENT_ENUM.map((obj: string) => (
                               <label class="flex items-center space-x-2 cursor-pointer p-1.5 hover:bg-white rounded transition-colors duration-150">
                                   <input type="checkbox" name="objects_present" value={obj} checked={dataRow.objects_present && dataRow.objects_present.includes(obj)} class="rounded border-slate-300 text-indigo-600 shadow-sm focus:ring-offset-0 focus:ring-0 w-4 h-4" />
                                   <span class="text-xs text-slate-600 font-medium">{obj.replace('_', ' ')}</span>
                               </label>
                           ))}
                       </div>
                   </div>
                </div>

                {/* 5. Detailed Verification */}
                <div class="space-y-6 pt-6 border-t border-slate-100 opacity-50 pointer-events-none transition-all" id="q-verify">
                     <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider">
                        Content Verification
                    </h3>
                    
                    {/* Common Questions */}
                    <div class="bg-white rounded-xl border border-slate-200 p-4 space-y-4">
                        <h4 class="text-sm font-bold text-slate-800 border-b border-slate-100 pb-2">Common Checks</h4>
                        
                        {/* Question 5.1 */}
                        <div>
                             <p class="text-sm text-slate-700 mb-2">Trang này có bị đánh sai tên không?</p>
                             <div class="flex gap-4">
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_1" value="no" checked onclick="toggleSection('err-q-v-1', false); checkChangeLog()" class="text-indigo-600 focus:ring-0"/> No</label>
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_1" value="yes" onclick="toggleSection('err-q-v-1', true); checkChangeLog()" class="text-rose-500 focus:ring-0"/> Yes</label>
                             </div>
                             <div id="err-q-v-1" class="hidden mt-2 ml-4 space-y-2 border-l-2 border-rose-200 pl-3">
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="ID_ISSUE" checked={dataRow.error_tags?.includes("ID_ISSUE")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">ID Issue</span></label>
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="IMAGE_MISMATCH" checked={dataRow.error_tags?.includes("IMAGE_MISMATCH")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Image Mismatch</span></label>
                             </div>
                        </div>
                        {/* Question 5.2 */}
                        <div>
                             <p class="text-sm text-slate-700 mb-2">Có suy luận đạo đức / giáo dục không?</p>
                             <div class="flex gap-4">
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_2" value="no" checked onclick="toggleSection('err-q-v-2', false); checkChangeLog()" class="text-indigo-600 focus:ring-0"/> No</label>
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_2" value="yes" onclick="toggleSection('err-q-v-2', true); checkChangeLog()" class="text-rose-500 focus:ring-0"/> Yes</label>
                             </div>
                             <div id="err-q-v-2" class="hidden mt-2 ml-4 border-l-2 border-rose-200 pl-3">
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="SUBJECTIVE_REASONING" checked={dataRow.error_tags?.includes("SUBJECTIVE_REASONING")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Subjective Reasoning</span></label>
                             </div>
                        </div>
                         {/* Question 5.3 */}
                         <div>
                             <p class="text-sm text-slate-700 mb-2">Có chi tiết bịa đặt không có trong ảnh không?</p>
                             <div class="flex gap-4">
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_3" value="no" checked onclick="toggleSection('err-q-v-3', false); checkChangeLog()" class="text-indigo-600 focus:ring-0"/> No</label>
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_3" value="yes" onclick="toggleSection('err-q-v-3', true); checkChangeLog()" class="text-rose-500 focus:ring-0"/> Yes</label>
                             </div>
                             <div id="err-q-v-3" class="hidden mt-2 ml-4 border-l-2 border-rose-200 pl-3">
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="HALLUCINATION" checked={dataRow.error_tags?.includes("HALLUCINATION")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Hallucination</span></label>
                             </div>
                        </div>
                         {/* Question 5.4 */}
                         <div>
                             <p class="text-sm text-slate-700 mb-2">Thứ tự có không hợp lý hay nhảy ý khó nghe không?</p>
                             <div class="flex gap-4">
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_4" value="no" checked onclick="toggleSection('err-q-v-4', false); checkChangeLog()" class="text-indigo-600 focus:ring-0"/> No</label>
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_4" value="yes" onclick="toggleSection('err-q-v-4', true); checkChangeLog()" class="text-rose-500 focus:ring-0"/> Yes</label>
                             </div>
                             <div id="err-q-v-4" class="hidden mt-2 ml-4 border-l-2 border-rose-200 pl-3">
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="DETAIL_INCOHERENT_FLOW" checked={dataRow.error_tags?.includes("DETAIL_INCOHERENT_FLOW")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Incoherent Flow</span></label>
                             </div>
                        </div>
                    </div>

                    {/* Cursor Short Specific */}
                     <div class="bg-white rounded-xl border border-slate-200 p-4 space-y-4">
                        <h4 class="text-sm font-bold text-slate-800 border-b border-slate-100 pb-2">Caption Short</h4>
                        
                         {/* Question 5.5 */}
                         <div>
                             <p class="text-sm text-slate-700 mb-2">Caption short có nằm ngoài 1-2 câu hay mô tả không đúng loại trang không?</p>
                              <div class="flex gap-4">
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_5" value="no" checked onclick="toggleSection('err-q-v-5', false); checkChangeLog()" class="text-indigo-600 focus:ring-0"/> No</label>
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_5" value="yes" onclick="toggleSection('err-q-v-5', true); checkChangeLog()" class="text-rose-500 focus:ring-0"/> Yes</label>
                             </div>
                             <div id="err-q-v-5" class="hidden mt-2 ml-4 space-y-2 border-l-2 border-rose-200 pl-3">
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="TOO_LONG_SHORT" checked={dataRow.error_tags?.includes("TOO_LONG_SHORT")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Too Long/Short</span></label>
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="MISQUOTED_TEXT" checked={dataRow.error_tags?.includes("MISQUOTED_TEXT")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Misquoted/Wrong Type</span></label>
                             </div>
                         </div>
                         
                          {/* Question 5.6 */}
                         <div>
                             <p class="text-sm text-slate-700 mb-2">Có dán OCR dài hay liệt kê quá chi tiết không?</p>
                              <div class="flex gap-4">
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_6" value="no" checked onclick="toggleSection('err-q-v-6', false); checkChangeLog()" class="text-indigo-600 focus:ring-0"/> No</label>
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_6" value="yes" onclick="toggleSection('err-q-v-6', true); checkChangeLog()" class="text-rose-500 focus:ring-0"/> Yes</label>
                             </div>
                             <div id="err-q-v-6" class="hidden mt-2 ml-4 border-l-2 border-rose-200 pl-3">
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="TOO_LONG_SHORT" checked={dataRow.error_tags?.includes("TOO_LONG_SHORT")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Too Detailed/OCR Dump</span></label>
                             </div>
                         </div>
                     </div>

                    {/* Caption Detail Specific */}
                     <div class="bg-white rounded-xl border border-slate-200 p-4 space-y-4">
                        <h4 class="text-sm font-bold text-slate-800 border-b border-slate-100 pb-2">Caption Detail</h4>
                        
                         {/* Question 5.7 */}
                         <div>
                             <p class="text-sm text-slate-700 mb-2">Tổng quan trang có đi sau chi tiết không?</p>
                             <div class="flex gap-4">
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_7" value="no" checked onclick="toggleSection('err-q-v-7', false); checkChangeLog()" class="text-indigo-600 focus:ring-0"/> No</label>
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_7" value="yes" onclick="toggleSection('err-q-v-7', true); checkChangeLog()" class="text-rose-500 focus:ring-0"/> Yes</label>
                             </div>
                             <div id="err-q-v-7" class="hidden mt-2 ml-4 border-l-2 border-rose-200 pl-3">
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="WRONG_LAYOUT" checked={dataRow.error_tags?.includes("WRONG_LAYOUT")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Wrong Layout (Overview Last)</span></label>
                             </div>
                         </div>

                          {/* Question 5.8 */}
                         <div>
                             <p class="text-sm text-slate-700 mb-2">Chữ trong ảnh minh họa có dẫn sai ngữ cảnh hoặc trái nguyên văn không?</p>
                             <div class="flex gap-4">
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_8" value="no" checked onclick="toggleSection('err-q-v-8', false); checkChangeLog()" class="text-indigo-600 focus:ring-0"/> No</label>
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_8" value="yes" onclick="toggleSection('err-q-v-8', true); checkChangeLog()" class="text-rose-500 focus:ring-0"/> Yes</label>
                             </div>
                             <div id="err-q-v-8" class="hidden mt-2 ml-4 grid grid-cols-2 gap-2 border-l-2 border-rose-200 pl-3">
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="MISQUOTED_TEXT" checked={dataRow.error_tags?.includes("MISQUOTED_TEXT")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Misquoted</span></label>
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="OCR_MISSING" checked={dataRow.error_tags?.includes("OCR_MISSING")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">OCR Missing</span></label>
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="OCR_WRONG" checked={dataRow.error_tags?.includes("OCR_WRONG")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">OCR Wrong</span></label>
                                  <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="OCR_NOT_CONTEXTUALIZED" checked={dataRow.error_tags?.includes("OCR_NOT_CONTEXTUALIZED")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Not Contextualized</span></label>
                                   <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="OCR_UNREADABLE" checked={dataRow.error_tags?.includes("OCR_UNREADABLE")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Unreadable</span></label>
                             </div>
                         </div>

                          {/* Question 5.9 */}
                         <div>
                             <p class="text-sm text-slate-700 mb-2">Thuyết minh có sai luồng_đọc(trên -> dưới, trái phải) hay làm người nghe không định vị được vị trí thuộc phần nào không?</p>
                             <div class="flex gap-4">
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_9" value="no" checked onclick="toggleSection('err-q-v-9', false); checkChangeLog()" class="text-indigo-600 focus:ring-0"/> No</label>
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_9" value="yes" onclick="toggleSection('err-q-v-9', true); checkChangeLog()" class="text-rose-500 focus:ring-0"/> Yes</label>
                             </div>
                             <div id="err-q-v-9" class="hidden mt-2 ml-4 space-y-2 border-l-2 border-rose-200 pl-3">
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="WRONG_LAYOUT" checked={dataRow.error_tags?.includes("WRONG_LAYOUT")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Wrong Layout/Flow</span></label>
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="DETAIL_INCOHERENT_FLOW" checked={dataRow.error_tags?.includes("DETAIL_INCOHERENT_FLOW")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Incoherent Flow</span></label>
                             </div>
                         </div>
                     </div>
                </div>

                {/* Final Check Display */}
                <div class="bg-rose-50 p-4 rounded-xl border border-rose-100 hidden" id="final-error-summary">
                    <h4 class="text-xs font-bold text-rose-800 uppercase mb-2">Verification Issues Identified:</h4>
                    <div class="flex flex-wrap gap-2" id="error-tags-list">
                        {/* Populated by JS */}
                    </div>
                </div>

              </div>

              {/* Notes & Changelog */}
              <div class="space-y-4 pt-6 border-t border-slate-100">
                  <div>
                      <h4 class="text-sm font-bold text-slate-800 mb-2">Is this note accurate?</h4>
                      <div class="flex items-center gap-4 mb-2">
                           <button type="button" onclick="document.getElementById('notes-edit-area').classList.remove('hidden'); document.getElementById('changelog_container').classList.remove('hidden');" class="px-3 py-1.5 text-xs bg-white border border-slate-200 text-slate-600 rounded hover:border-amber-400 hover:text-amber-600">No, edit note</button>
                           {dataRow.notes ? (
                               <p class="text-sm text-slate-600 italic">"{dataRow.notes}"</p>
                           ) : (
                               <p class="text-sm text-slate-400 italic">No notes</p>
                           )}
                      </div>
                      <div id="notes-edit-area" class="hidden animate-fade-in">
                          <textarea name="notes" rows="2" class="w-full text-sm border-amber-200 rounded-lg p-2.5 focus:ring-amber-500 focus:border-amber-500 bg-amber-50" placeholder="Enter correct notes..." oninput="document.getElementById('changelog_container').classList.remove('hidden')">{dataRow.notes || ""}</textarea>
                      </div>
                  </div>
                   <div id="changelog_container" class="hidden animate-fade-in">
                      <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Change Log</label>
                      <input type="text" name="change_log" class="w-full text-sm border-indigo-200 rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500 bg-indigo-50/50" placeholder="Explain what changed..." />
                  </div>
              </div>

              <div class="sticky bottom-0 bg-white pt-4 pb-2 border-t border-slate-100 -mx-8 px-8 z-30 flex gap-4">
                <button
                  id="save-btn"
                  type="submit"
                  disabled={isSaved}
                  class={`flex-1 flex justify-center items-center py-3.5 px-4 border border-transparent rounded-xl shadow-lg text-sm font-bold text-white transition-all ${isSaved ? 'bg-slate-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700'}`}
                >
                  {isSaved ? 'Saved!' : 'Save (Update Row)'}
                </button>
                 <a
                  href="/"
                  id="continue-btn"
                  class={`flex-1 flex justify-center items-center py-3.5 px-4 border border-indigo-200 bg-white text-indigo-700 rounded-xl shadow-sm text-sm font-bold transition-all ${isSaved ? 'hover:bg-indigo-50' : 'pointer-events-none opacity-50'}`}
                >
                  Continue (Next Random)
                </a>
              </div>
            </form>
          </div>
        </div>
      ) : (
        <div class="flex items-center justify-center flex-col h-full text-slate-400 text-sm space-y-4">
          <p>No more items found for these filters.</p>
          <button
            onclick="document.cookie='dataset_filter=; Max-Age=0; path=/'; window.location.reload()"
            class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors"
          >
            Clear Filters & Try Again
          </button>
        </div>
      )
    }
    <script is:inline>
      // New Logic for Questionnaire
      function toggleSection(id, show) {
        const el = document.getElementById(id);
        if(!el) return;
        if (show) {
          el.classList.remove("hidden");
        } else {
          el.classList.add("hidden");
        }
      }

      function revealNext(id) {
          const el = document.getElementById(id);
          if(!el) return;
          el.classList.remove('opacity-50', 'pointer-events-none');
      }

      function toggleEditCaption(inputId, btnId) {
          const input = document.getElementById(inputId);
          const btn = document.getElementById(btnId);
          const btnText = btn.querySelector('.btn-text');
          
          if(input.readOnly) {
              // Switch to Edit Mode
              input.readOnly = false;
              input.focus();
              btnText.innerText = "Save";
              btn.classList.remove('opacity-70');
              btn.classList.add('bg-indigo-500', 'text-white');
          } else {
              // Switch to Saved Mode (Lock)
              input.readOnly = true;
              btnText.innerText = "Edit";
              btn.classList.add('opacity-70');
              btn.classList.remove('bg-indigo-500', 'text-white');
              // Trigger changelog if needed
              checkChangeLog();
          }
      }

      // Populate Final Summary based on checkboxes
      function updateFinalSummary() {
          const summaryContainer = document.getElementById('final-error-summary');
          const listContainer = document.getElementById('error-tags-list');
          const checkboxes = document.querySelectorAll('input[name="error_tags"]:checked');
          
          listContainer.innerHTML = '';
          if(checkboxes.length > 0) {
              summaryContainer.classList.remove('hidden');
              checkboxes.forEach(cb => {
                  const tag = cb.value;
                  const span = document.createElement('span');
                  span.className = "px-2 py-1 bg-rose-100 text-rose-700 border border-rose-200 rounded text-xs font-bold";
                  span.innerText = tag.replace('OCR_', '').replace(/_/g, ' ');
                  listContainer.appendChild(span);
              });
          } else {
              summaryContainer.classList.add('hidden');
          }
      }

      function checkChangeLog() {
        // Run final summary update too
        updateFinalSummary();

        const cl = document.getElementById("changelog_container");
        
        // 1. Check if any "edit" section hidden inputs are showing? 
        // Not reliable, better to check if any "No" radio is checked.
        // We use querySelectorAll for all radios with value 'no' or 'yes' that trigger changes.
        // But specifically, we want to know if *Data* Changed.
        
        let changed = false;

        // Check verification "Yes" answers (value="yes" means error present in our q_v_* logic)
        const verifYes = document.querySelectorAll('input[name^="q_v_"][value="yes"]:checked');
        if (verifYes.length > 0) changed = true;

        // Check classification "No" answers (value="no" means override needed)
        const classNo = document.querySelectorAll('input[name^="q_page_type"][value="no"]:checked, input[name^="q_has_"][value="no"]:checked, input[name^="q_objects"][value="no"]:checked');
        if (classNo.length > 0) changed = true;
        
        // Check manual edits in Note/Captions
        const noteArea = document.getElementById('notes-edit-area');
        if (noteArea && !noteArea.classList.contains('hidden')) changed = true;
        
        if (changed) {
             cl.classList.remove("hidden");
        } else {
             cl.classList.add("hidden");
        }
      }

      // Attach global listeners
      document.addEventListener("change", (e) => {
         if(e.target.name === 'error_tags') {
             updateFinalSummary();
         }
         checkChangeLog();
      });

      // Initial run
      updateFinalSummary();
      
      document.addEventListener("DOMContentLoaded", () => {
         // Initialize states based on checked boxes
         document.querySelectorAll('input[name="error_tags"]:checked').forEach(cb => {
            // Find parent error container
            const errDiv = cb.closest('div[id^="err-q-v-"]');
            if(errDiv) {
                // Reveal it
                errDiv.classList.remove('hidden');
                // Set corresponding radio to Yes
                const qName = 'q' + errDiv.id.substring(3).replace(/-/g, '_'); // err-q-v-1 -> q_v_1? No. id is err-q-v-1. name is q_v_1.
                // substring(4) of 'err-q-v-1' is 'q-v-1'. replace - with _ -> q_v_1.
                // Wait, id is "err-q-v-1". 
                // name is "q_v_1".
                // Logic: 
                const nameParts = errDiv.id.split('-'); // ['err', 'q', 'v', '1']
                // name should be q_v_1
                const radioName = nameParts.slice(1).join('_');
                const yesRadio = document.querySelector(`input[name="${radioName}"][value="yes"]`);
                if(yesRadio) yesRadio.checked = true;
            }
         });
         
         updateFinalSummary();
         checkChangeLog();
      });

      // Filter Logic (Keep existing)

      const filterBtn = document.getElementById("filter-btn");
      const filterModal = document.getElementById("filter-modal");
      const closeFilter = document.getElementById("close-filter");
      const applyFilter = document.getElementById("apply-filter");
      const selectAll = document.getElementById("select-all");
      const clearAll = document.getElementById("clear-all");

      if (filterBtn) {
        filterBtn.addEventListener("click", () => {
          filterModal.classList.remove("hidden");
        });

        closeFilter.addEventListener("click", () => {
          filterModal.classList.add("hidden");
        });

        // Close on clicking outside
        document.addEventListener("click", (e) => {
          if (
            !filterModal.contains(e.target) &&
            !filterBtn.contains(e.target)
          ) {
            filterModal.classList.add("hidden");
          }
        });

        selectAll.addEventListener("click", () => {
          document
            .querySelectorAll('input[name="prefix_filter"]')
            .forEach((cb) => (cb.checked = true));
        });

        clearAll.addEventListener("click", () => {
          document
            .querySelectorAll('input[name="prefix_filter"]')
            .forEach((cb) => (cb.checked = false));
        });

        applyFilter.addEventListener("click", () => {
          const selected = Array.from(
            document.querySelectorAll('input[name="prefix_filter"]:checked'),
          ).map((cb) => cb.value);
          // Save to cookie (1 year expiry)
          const d = new Date();
          d.setTime(d.getTime() + 365 * 24 * 60 * 60 * 1000);
          document.cookie = `dataset_filter=${encodeURIComponent(JSON.stringify(selected))}; expires=${d.toUTCString()}; path=/`;
          window.location.reload();
        });
      }
    </script>
  </body>
</html>
