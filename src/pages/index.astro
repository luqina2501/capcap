---
import { supabase } from "../db/supabase";
import "../styles/global.css";
import { ViewTransitions } from "astro:transitions";

// Enums
const PAGE_TYPES = [
  "cover",
  "title_page",
  "toc",
  "content",
  "exercise",
  "blank",
  "other",
];
const OBJECTS_PRESENT_ENUM = [
  "person_child",
  "person_adult",
  "student",
  "teacher",
  "animal_generic",
  "animal_pet",
  "animal_farm",
  "animal_wild",
  "food_fruit",
  "food_vegetable",
  "food_bundle",
  "book",
  "notebook",
  "pen",
  "pencil",
  "school_bag",
  "clock_analog",
  "clock_digital",
  "countable_object",
  "grouped_object",
  "table",
  "chart",
  "illustration_scene",
];
const ERROR_TAGS = [
  "OCR_MISSING",
  "OCR_WRONG",
  "OCR_UNREADABLE",
  "OCR_NOT_CONTEXTUALIZED",
  "HALLUCINATION",
  "WRONG_LAYOUT",
  "SUBJECTIVE_REASONING",
  "TOO_LONG_SHORT",
  "DETAIL_INCOHERENT_FLOW",
  "MISQUOTED_TEXT",
  "COUNTING_WRONG",
  "CLOCK_READING_WRONG",
  "ID_ISSUE",
  "IMAGE_MISMATCH",
];

const REVIEW_PRIORITY_ENUM = ["low", "normal", "high"];
const IS_CHECKED_ENUM = ["unchecked", "checked", "reviewed"];

const AUTO_FLAGS = [
  "OCR_UNREADABLE",
  "OCR_LONG",
  "HAS_TABLE",
  "LAYOUT_COMPLEX",
  "POSSIBLE_BLANK",
  "LOW_CERTAINTY",
  "COUNTING_WRONG",
  "CLOCK_READING_WRONG",
];

const PREFIXES = [
  "SGK_CanhDieu_DaoDuc_1",
  "SGK_CanhDieu_DaoDuc_2",
  "SGK_CanhDieu_DaoDuc_3",

  "SGK_CanhDieu_TiengViet_2_Tap1",
  "SGK_CanhDieu_TiengViet_2_Tap2",

  "SGK_CanhDieu_Toan_1",
  "SGK_CanhDieu_Toan_3_Tap1",

  "SGK_CanhDieu_TuNhienVaXaHoi_1",
  "SGK_CanhDieu_TuNhienVaXaHoi_2",
  "SGK_CanhDieu_TuNhienVaXaHoi_3",
];

let message = "";
let finished = false;
let totalCount = 0;
let checkedCount = 0;
const isSaved = new URL(Astro.request.url).searchParams.get("saved") === "true";

if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const id = formData.get("id");

    // Check if we are just saving or saving & continuing (not strictly needed if we just reload)
    // But let's handle the data update first.

    const page_type = formData.get("page_type");
    const has_text = formData.has("has_text"); // Checkbox logic: strictly this might need review if UI sends "yes"/"no" from dropdown
    // Requirement says dropdown True/False. If it's a select with value "true"/"false", formData.get() returns string.
    // If it is a checkbox, formData.has() works.
    // The UI implementation plan says dropdown. Let's assume standard form behavior.
    // I will adjust UI to send "true"/"false" strings or boolean-like values.

    // Actually, let's look at the UI implementation plan again.
    // "dropdown(True/False) to has_text"
    const has_text_val = formData.get("has_text");
    const has_table_val = formData.get("has_table");

    const objects_present = formData.getAll("objects_present");
    const error_tags = formData.getAll("error_tags");
    const auto_flags = formData.getAll("auto_flags");
    const notes = formData.get("notes");
    const change_log = formData.get("change_log");

    const caption_short = formData.get("caption_short");
    const caption_detail = formData.get("caption_detail");
    const text_in_image = formData.get("text_in_image"); // verification

    const { error: updateError } = await supabase
      .from("dataset")
      .update({
        page_type,
        has_text: has_text_val === "true" || has_text_val === "on",
        has_table: has_table_val === "true" || has_table_val === "on",
        objects_present,
        error_tags: [...new Set(error_tags)], // Deduplicate tags
        auto_flags, // Added this
        notes: notes ? notes : null,
        change_log: change_log ? change_log : null,
        caption_short: caption_short ? caption_short : null,
        caption_detail: caption_detail ? caption_detail : null,
        text_in_image: text_in_image ? text_in_image : null,
        is_checked: "checked", // Enum value
      })
      .eq("id", id);

    if (updateError) {
      console.error("Update Error:", updateError);
      message = "Error updating row: " + updateError.message;
    } else {
      console.log("Updated successful:", id);
      // Preserve existing URL params when redirecting
      const currentUrl = new URL(Astro.request.url);
      const mode = currentUrl.searchParams.get("mode") || "random";
      const filterIsChecked = currentUrl.searchParams.get("filter_is_checked") || "unchecked";
      const filterPriority = currentUrl.searchParams.get("filter_priority");
      
      let redirectUrl = `/?search_id=${id}&saved=true`;
      if (mode === "sequential") redirectUrl += `&mode=sequential`;
      if (filterIsChecked && filterIsChecked !== "unchecked") redirectUrl += `&filter_is_checked=${filterIsChecked}`;
      if (filterPriority) redirectUrl += `&filter_priority=${filterPriority}`;
      
      return Astro.redirect(redirectUrl);
    }
  } catch (e) {
    console.error("Submission error:", e);
    message = "Server error processing request.";
  }
}

// --- Filter Logic ---
const cookieHeader = Astro.request.headers.get("cookie") || "";
// Simple cookie parser
const getCookie = (name: string) => {
  const value = `; ${cookieHeader}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop()?.split(";").shift();
  return null;
};

const filterCookie = getCookie("dataset_filter");
let activeFilters = PREFIXES; // Default to all
if (filterCookie) {
  try {
    const parsed = JSON.parse(decodeURIComponent(filterCookie));
    if (Array.isArray(parsed) && parsed.length > 0) {
      activeFilters = parsed;
    }
  } catch (e) {
    console.error("Error parsing filter cookie", e);
  }
}

// Additional Filters (Requirement 3: Search, Review Priority, Is Checked)
// We'll implemented basic handling here.
// Ideally we should have a comprehensive filter state, but for now let's focus on the random fetch.
// If the user performed a search (e.g. via GET param `search_id`), prioritize that.
const url = new URL(Astro.request.url);
const searchId = url.searchParams.get("search_id");
const filterIsChecked =
  url.searchParams.get("filter_is_checked") || "unchecked"; // unchecked, checked, reviewed, all
const filterPriority = url.searchParams.get("filter_priority"); // low, normal, high, or null (all)
const viewMode = url.searchParams.get("mode") || "random"; // random or sequential

let dataRow = null;
let prevId: string | null = null;
let nextId: string | null = null;
let currentIndex = 0;
let sequentialTotal = 0;

if (!finished) {
  if (searchId) {
    const { data } = await supabase
      .from("dataset")
      .select("*")
      .eq("id", searchId)
      .single();
    if (data) dataRow = data;
    
    // In sequential mode with searchId, find prev/next
    if (viewMode === "sequential" && data) {
      const filterQuery = activeFilters.map((p) => `id.like.${p}%`).join(",");
      
      // Build base query for sequential navigation
      let baseQuery = supabase.from("dataset").select("id");
      if (filterIsChecked !== "all") {
        baseQuery = baseQuery.eq("is_checked", filterIsChecked);
      }
      if (filterPriority) {
        baseQuery = baseQuery.eq("review_priority", filterPriority);
      }
      if (filterQuery) {
        baseQuery = baseQuery.or(filterQuery);
      }
      
      // Get all IDs sorted
      const { data: allIds } = await baseQuery.order("id", { ascending: true });
      if (allIds && allIds.length > 0) {
        sequentialTotal = allIds.length;
        const currentIdx = allIds.findIndex((r) => r.id === searchId);
        if (currentIdx !== -1) {
          // Current item is in filtered results
          currentIndex = currentIdx + 1; // 1-based
          if (currentIdx > 0) prevId = allIds[currentIdx - 1].id;
          if (currentIdx < allIds.length - 1) nextId = allIds[currentIdx + 1].id;
        } else {
          // Current item is NOT in filtered results (e.g., viewing book A but filtering book B)
          // Allow navigation to first item of filtered results
          currentIndex = 0; // Show as "0 / total" to indicate current item is outside filter
          nextId = allIds[0].id; // Navigate to first item in filter
        }
      }
    }
  } else if (viewMode === "sequential") {
    // Sequential mode: get first item in sorted order
    const filterQuery = activeFilters.map((p) => `id.like.${p}%`).join(",");
    
    let query = supabase.from("dataset").select("*");
    if (filterIsChecked !== "all") {
      query = query.eq("is_checked", filterIsChecked);
    }
    if (filterPriority) {
      query = query.eq("review_priority", filterPriority);
    }
    if (filterQuery) {
      query = query.or(filterQuery);
    }
    
    // Get first item sorted by ID
    const { data } = await query.order("id", { ascending: true }).limit(1);
    if (data && data.length > 0) {
      dataRow = data[0];
      
      // Get all IDs for navigation
      let idsQuery = supabase.from("dataset").select("id");
      if (filterIsChecked !== "all") {
        idsQuery = idsQuery.eq("is_checked", filterIsChecked);
      }
      if (filterPriority) {
        idsQuery = idsQuery.eq("review_priority", filterPriority);
      }
      if (filterQuery) {
        idsQuery = idsQuery.or(filterQuery);
      }
      
      const { data: allIds } = await idsQuery.order("id", { ascending: true });
      if (allIds) {
        sequentialTotal = allIds.length;
        currentIndex = 1;
        if (allIds.length > 1) nextId = allIds[1].id;
      }
    }
  } else {
    // Weighted Random Selection: High(50%), Normal(33%), Low(17%)
    const rand = Math.random();
    let priorityTarget = "normal";
    if (rand < 0.5) priorityTarget = "high";
    else if (rand < 0.83) priorityTarget = "normal";
    else priorityTarget = "low";

    // If we filter by specific priority from UI, override this
    if (filterPriority) priorityTarget = filterPriority;

    // Helper to build query
    const buildQuery = (prio: string) => {
      let query = supabase
        .from("dataset")
        .select("*")
        .eq("review_priority", prio);

      if (filterIsChecked !== "all") {
        query = query.eq("is_checked", filterIsChecked);
      }

      // Prefix filters
      const filterQuery = activeFilters.map((p) => `id.like.${p}%`).join(",");
      if (filterQuery) {
        query = query.or(filterQuery);
      }
      return query;
    };

    // Try fetching with target priority
    let { data } = await buildQuery(priorityTarget).limit(50);

    // If no data found for this priority, fallback to others?
    // The requirement implies strictly weighted, but users usually want *some* data.
    // Let's try other priorities if data is empty.
    if (!data || data.length === 0) {
      // Try any priority
      let query = supabase.from("dataset").select("*");
      if (filterIsChecked !== "all")
        query = query.eq("is_checked", filterIsChecked);
      const filterQuery = activeFilters.map((p) => `id.like.${p}%`).join(",");
      if (filterQuery) query = query.or(filterQuery);

      const { data: fallbackData } = await query.limit(50);
      if (fallbackData && fallbackData.length > 0) {
        data = fallbackData;
      }
    }

    if (data && data.length) {
      dataRow = data[Math.floor(Math.random() * data.length)];
    }
  }

  // Calculate Progress (Requirement 2)
  // checked / total in filtered prefixes
  totalCount = 0;
  checkedCount = 0;

  // Build filter query string for reuse
  const prefixFilterStr = activeFilters.map((p) => `id.like.${p}%`).join(",");

  let totalQuery = supabase
    .from("dataset")
    .select("*", { count: "exact", head: true });

  let checkedQuery = supabase
    .from("dataset")
    .select("*", { count: "exact", head: true })
    .neq("is_checked", "unchecked"); // "checked" or "reviewed" counts as progress

  if (prefixFilterStr) {
    totalQuery = totalQuery.or(prefixFilterStr);
    checkedQuery = checkedQuery.or(prefixFilterStr);
  }

  const [totalRes, checkedRes] = await Promise.all([totalQuery, checkedQuery]);
  if (totalRes.count !== null) totalCount = totalRes.count;
  if (checkedRes.count !== null) checkedCount = checkedRes.count;

  if (!dataRow && !searchId) {
    if (totalCount > 0 && totalCount === checkedCount) {
      finished = true;
    }
  }
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>Dataset Review</title>
    <ViewTransitions />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    {/* Preload next/prev images for faster navigation */}
    {prevId && (
      <link rel="preload" as="image" href={`${import.meta.env.SUPABASE_URL}/storage/v1/object/public/images/${prevId}.png`} />
    )}
    {nextId && (
      <link rel="preload" as="image" href={`${import.meta.env.SUPABASE_URL}/storage/v1/object/public/images/${nextId}.png`} />
    )}
    {/* Prefetch next/prev pages for instant navigation */}
    {prevId && (
      <link rel="prefetch" href={`/?search_id=${prevId}&mode=sequential&filter_is_checked=${filterIsChecked}${filterPriority ? `&filter_priority=${filterPriority}` : ''}`} />
    )}
    {nextId && (
      <link rel="prefetch" href={`/?search_id=${nextId}&mode=sequential&filter_is_checked=${filterIsChecked}${filterPriority ? `&filter_priority=${filterPriority}` : ''}`} />
    )}
    <style>
      ::selection {
        background-color: #cbd5e1;
        color: #0f172a;
      }
      /* Updated: Use Inter for better readability */
      body {
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        font-weight: 500;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      /* Keep monospace only for code/ID elements */
      .font-mono {
        font-family: 'Liberation Mono', 'Courier New', monospace;
      }
      /* Resize handles */
      .resize-handle-h {
        width: 8px;
        cursor: col-resize;
        background-color: #3f3f46;
        transition: background-color 0.15s;
        flex-shrink: 0;
      }
      .resize-handle-h:hover, .resize-handle-h.active {
        background-color: #6366f1;
      }
      .resize-handle-v {
        height: 8px;
        cursor: row-resize;
        background-color: #e2e8f0;
        transition: background-color 0.15s;
        flex-shrink: 0;
      }
      .resize-handle-v:hover, .resize-handle-v.active {
        background-color: #6366f1;
      }
      .no-select {
        user-select: none;
        -webkit-user-select: none;
      }
    </style>
  </head>
  <body
    class="bg-white text-slate-900 h-screen overflow-hidden antialiased"
  >
    {
      finished ? (
        <div class="flex flex-col items-center justify-center h-full w-full bg-slate-50">
          <div class="max-w-md text-center space-y-6">
            <h1 class="text-3xl font-bold text-slate-900">Hoàn thành!</h1>
            <p class="text-slate-500">
              Bạn đã kiểm tra xong toàn bộ dữ liệu.
            </p>
            <button
              onclick="window.location.reload()"
              class="px-6 py-2 bg-slate-900 text-white font-medium rounded-lg hover:bg-slate-800 transition-colors"
            >
              Kiểm tra lại
            </button>
          </div>
        </div>
      ) : dataRow ? (
        <div class="flex h-full" id="main-container">
          {/* Left: Image */}
          <div id="left-panel" class="bg-zinc-900 flex flex-col relative" style="width: 41.67%; min-width: 250px;">
            {/* Header / Progress / Search */}
            <div class="flex-none p-4 flex flex-col gap-4 bg-zinc-900 border-b border-white/5 shadow-2xl z-10">
              <div class="flex justify-between items-center">
                 <span class="font-mono text-xs text-zinc-300">ID: {dataRow.id}</span>
                 <span class={`text-xs uppercase tracking-wider font-bold px-2 py-1 rounded ${dataRow.review_priority === 'high' ? 'bg-rose-900/50 text-rose-300' : dataRow.review_priority === 'normal' ? 'bg-blue-900/50 text-blue-300' : 'bg-zinc-800 text-zinc-400'}`}>
                    {dataRow.review_priority} Priority
                 </span>
              </div>
              
               {/* Progress bar moved to bottom (Req 8) */}



              {/* Requirement 7: Filter Options (Separated from Search, Taller Header) */}

              {/* Requirement: Separate Search Filter (Scope) and Randomizer Filter (Settings) */}
               <div class="pt-4 border-t border-white/10 flex justify-between items-center relative gap-2">
                   
                   {/* 1. Scope (Prefixes) */}
                   <div class="relative">
                      <button id="scope-btn" class="flex items-center space-x-1 text-xs font-bold text-zinc-300 hover:text-white transition-colors bg-zinc-800 hover:bg-zinc-700 px-2 py-1.5 rounded border border-white/10">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                        <span>Books ({activeFilters.length === PREFIXES.length ? "All" : activeFilters.length})</span>
                      </button>
                      
                       <div id="scope-modal" class="hidden absolute top-full left-0 w-64 bg-white shadow-2xl rounded-xl border border-slate-200 z-50 animate-fade-in flex flex-col max-h-[60vh] mt-2">
                           <div class="p-3 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
                              <h3 class="font-bold text-slate-700 text-xs">Book Scope</h3>
                              <button id="close-scope" class="text-slate-400 hover:text-rose-500"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                           </div>
                           <div class="overflow-y-auto p-3 space-y-2 flex-1 custom-scrollbar text-left">
                                <div class="flex justify-between items-center">
                                  <span class="text-xs font-bold text-slate-500 uppercase">Select Books</span>
                                  <div class="flex space-x-2 text-xs">
                                    <button id="select-all" class="text-indigo-600 hover:text-indigo-800">All</button>
                                    <button id="clear-all" class="text-slate-500 hover:text-rose-500">None</button>
                                  </div>
                                </div>
                                <div class="space-y-1">
                                  {PREFIXES.map((prefix) => (
                                    <label class="flex items-start space-x-2 cursor-pointer group p-1 hover:bg-white rounded">
                                      <input type="checkbox" name="prefix_filter" value={prefix} checked={activeFilters.includes(prefix)} class="mt-0.5 rounded border-slate-300 text-indigo-600 shadow-sm focus:ring-0 w-3.5 h-3.5" />
                                      <span class="text-xs text-slate-600 group-hover:text-slate-900 break-all leading-tight">{prefix}</span>
                                    </label>
                                  ))}
                                </div>
                           </div>
                           <div class="p-3 border-t border-slate-100 bg-slate-50 rounded-b-xl">
                              <button id="apply-scope" class="w-full py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded font-bold shadow-md transition-all text-xs">Apply Scope</button>
                           </div>
                       </div>
                   </div>

                   {/* 2. Settings (Randomizer) */}
                   <div class="relative">
                      <button id="settings-btn" class="flex items-center space-x-1 text-xs font-bold text-zinc-300 hover:text-white transition-colors bg-zinc-800 hover:bg-zinc-700 px-2 py-1.5 rounded border border-white/10">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        <span>{viewMode === "sequential" ? "Tuần tự" : "Ngẫu nhiên"}</span>
                      </button>

                       <div id="settings-modal" class="hidden absolute top-full right-0 w-64 bg-white shadow-2xl rounded-xl border border-slate-200 z-50 animate-fade-in flex flex-col mt-2">
                           <div class="p-3 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
                              <h3 class="font-bold text-slate-700 text-xs">Cài đặt</h3>
                              <button id="close-settings" class="text-slate-400 hover:text-rose-500"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                           </div>
                           <div class="p-3 space-y-4 text-left">
                               <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">Chế độ xem</label>
                                <select id="view-mode" class="w-full text-xs border-slate-300 rounded shadow-sm focus:border-indigo-500 focus:ring-indigo-200">
                                  <option value="random" selected={viewMode === "random"}>Ngẫu nhiên</option>
                                  <option value="sequential" selected={viewMode === "sequential"}>Tuần tự (←/→)</option>
                                </select>
                              </div>
                               <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">Độ ưu tiên</label>
                                <select id="filter-priority" class="w-full text-xs border-slate-300 rounded shadow-sm focus:border-indigo-500 focus:ring-indigo-200">
                                  <option value="">Tất cả</option>
                                  {REVIEW_PRIORITY_ENUM.map((p) => (
                                    <option value={p} selected={filterPriority === p}>{p.toUpperCase()}</option>
                                  ))}
                                </select>
                              </div>
                              <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">Trạng thái</label>
                                <select id="filter-is-checked" class="w-full text-xs border-slate-300 rounded shadow-sm focus:border-indigo-500 focus:ring-indigo-200">
                                  <option value="all" selected={filterIsChecked === "all"}>Tất cả</option>
                                  {IS_CHECKED_ENUM.map((s) => (
                                    <option value={s} selected={filterIsChecked === s}>{s.toUpperCase()}</option>
                                  ))}
                                </select>
                              </div>
                           </div>
                           <div class="p-3 border-t border-slate-100 bg-slate-50 rounded-b-xl">
                              <button id="apply-settings" class="w-full py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded font-bold shadow-md transition-all text-xs">Áp dụng</button>
                           </div>
                       </div>
                   </div>
              </div>

              {/* Requirement 6: Search in UI.Left.Top */}
              <div class="relative pb-2">
                  <input 
                      type="text" 
                      id="header-search-input" 
                      placeholder="Search ID..." 
                      class="w-full bg-zinc-800 text-sm text-white border-none rounded-lg focus:ring-1 focus:ring-indigo-500 pl-8"
                      onkeydown="if(event.key === 'Enter') { window.location.href='/?search_id='+this.value; }"
                  />
                  <svg class="w-4 h-4 text-zinc-500 absolute left-2.5 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
              </div>
            </div>
            <div class="flex-1 flex flex-col items-center justify-start p-6 overflow-y-auto">
              <img
                src={`${import.meta.env.SUPABASE_URL}/storage/v1/object/public/images/${dataRow.id}.png`}
                alt="Dataset Image"
                class="w-full h-auto object-contain shadow-2xl mb-6 rounded-lg"
              />
            </div>
            
            {/* Requirement 8: Progress Bar at Bottom */}
            <div class="flex-none p-4 bg-zinc-900 border-t border-white/5 z-10">
                 <div class="w-full">
                  <div class="flex justify-between items-end mb-1">
                      <span class="text-xs uppercase tracking-wider font-bold text-zinc-300">Tiến độ</span>
                      <div class="flex items-center gap-2">
                          <span class="text-sm font-bold text-white">{checkedCount} / {totalCount}</span>
                          <span class="text-xs text-zinc-300">({totalCount > 0 ? Math.round((checkedCount / totalCount) * 100) : 0}%)</span>
                      </div>
                  </div>
                  <div class="w-full h-3 bg-zinc-800 rounded-full overflow-hidden">
                     <div class="h-full bg-indigo-500 rounded-full shadow-[0_0_10px_rgba(99,102,241,0.5)] transition-all duration-500" style={`width: ${totalCount > 0 ? (checkedCount / totalCount) * 100 : 0}%`}></div>
                  </div>
              </div>
            </div>
          </div>

          {/* Horizontal Resize Handle */}
          <div id="resize-handle-h" class="resize-handle-h"></div>

          {/* Right: Form */}
          <div id="right-panel" class="bg-slate-50 border-l border-slate-200 flex flex-col relative" style="flex: 1; min-width: 400px;">
            <div class="px-8 py-5 border-b border-slate-200 flex justify-between items-center bg-slate-100 z-20">
              <div class="flex items-baseline space-x-3">
                <h2 class="font-semibold text-slate-900 text-lg">
                  Kiểm tra dữ liệu
                </h2>
                <span class="text-xs text-slate-400 uppercase tracking-widest font-medium">
                  C=Có, K=Không, S=Bỏ qua
                </span>
              </div>
            </div>

            {message && (
              <div class="mx-8 mt-6 p-4 bg-emerald-50 text-emerald-700 text-sm rounded-lg border border-emerald-100 flex items-center gap-2">
                <svg
                  class="w-5 h-5 flex-shrink-0"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  />
                </svg>
                {message}
              </div>
            )}

            {/* Captions Fixed Top (Req 6 & 7 & 8) */}
            <div id="caption-panel" class="shrink-0 bg-slate-100 border-b border-slate-200 p-6 shadow-md z-30 flex flex-col" style="height: 35%; min-height: 120px; max-height: 70%;">
               {/* Caption Short */}
                 <div class="group mb-4 shrink-0">
                   <div class="flex justify-between items-baseline mb-2">
                        <label class="text-xs font-bold text-slate-600 uppercase tracking-widest border-l-2 border-indigo-500 pl-2">Caption Short</label>
                        <button type="button" id="btn-edit-caption-short" class="px-2 py-1 text-xs bg-white text-slate-500 border border-slate-300 rounded-full hover:bg-indigo-500 hover:text-white transition-all opacity-70 group-hover:opacity-100 flex items-center gap-1" onclick="toggleEditCaption('caption_short_input', 'btn-edit-caption-short')">
                             <span class="btn-text">Edit</span>
                        </button>
                   </div>
                   <textarea
                     id="caption_short_input"
                     name="caption_short" 
                     form="main-form"
                     rows="2"
                     readonly
                     class="w-full bg-slate-50 border border-slate-300 rounded-md text-base leading-relaxed font-medium text-slate-900 placeholder-slate-400 focus:ring-indigo-500 focus:border-indigo-500 transition-all resize-none p-3 read-only:bg-transparent read-only:border-0 read-only:border-b read-only:border-slate-300 read-only:rounded-none read-only:px-0 read-only:cursor-text"
                     placeholder="No short caption..."
                     oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'; document.getElementById('changelog_container').classList.remove('hidden')"
                     onfocus="this.classList.remove('read-only:border-slate-300');"
                     onblur="this.classList.add('read-only:border-slate-300');"
                   >{dataRow.caption_short || ""}</textarea>
                 </div>
                 
                 {/* Caption Detail */}
                 <div class="group flex-1 flex flex-col min-h-0">
                    <div class="flex justify-between items-baseline mb-2 shrink-0">
                        <label class="text-xs font-bold text-slate-600 uppercase tracking-widest border-l-2 border-indigo-500 pl-2">Caption Detail</label>
                        <button type="button" id="btn-edit-caption-detail" class="px-2 py-1 text-xs bg-white text-slate-500 border border-slate-300 rounded-full hover:bg-indigo-500 hover:text-white transition-all opacity-70 group-hover:opacity-100 flex items-center gap-1" onclick="toggleEditCaption('caption_detail_input', 'btn-edit-caption-detail')">
                            <span class="btn-text">Edit</span>
                        </button>
                   </div>
                   <textarea
                     id="caption_detail_input"
                     name="caption_detail"
                     form="main-form"
                     readonly
                     class="w-full flex-1 bg-slate-50 border border-slate-300 rounded-md text-base leading-loose font-medium text-slate-900 placeholder-slate-400 focus:ring-indigo-500 focus:border-indigo-500 transition-all resize-none p-3 read-only:bg-transparent read-only:border-0 read-only:border-b read-only:border-slate-300 read-only:rounded-none read-only:px-0 read-only:cursor-text overflow-y-auto"
                     placeholder="No detail caption..."
                      oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'; document.getElementById('changelog_container').classList.remove('hidden')"
                      onfocus="this.classList.remove('read-only:border-slate-300');"
                      onblur="this.classList.add('read-only:border-slate-300');"
                   >{dataRow.caption_detail || ""}</textarea>
                 </div>
            </div>

            {/* Vertical Resize Handle */}
            <div id="resize-handle-v" class="resize-handle-v"></div>

            <form
              id="main-form"
              method="POST"
              class="flex-1 overflow-y-auto p-8 space-y-10"
            >
              <input type="hidden" name="id" value={dataRow.id} />

              {/* Questionnaire Section */}
              <div class="space-y-8">
                
                {/* 1. Page Type */}
                <div class="bg-indigo-50/50 p-5 rounded-xl border border-indigo-100 transition-all question-block" id="q-page-type" data-next="q-has-text">
                    <div class="flex flex-col gap-3">
                        <div class="flex justify-between items-start">
                            <h3 class="text-sm font-bold text-indigo-900 uppercase tracking-wide">
                                1. Đây có phải trang <span class="text-indigo-600">"{dataRow.page_type.replace('_', ' ')}"</span> không?
                            </h3>
                            <button type="button" class="skip-btn text-xs text-slate-400 hover:text-indigo-600 px-2 py-1 rounded hover:bg-indigo-50" onclick="skipQuestion('q-page-type', 'q-has-text')">Bỏ qua →</button>
                        </div>
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-indigo-100 hover:border-indigo-300 transition-colors shadow-sm">
                                <input type="radio" name="q_page_type" value="yes" class="text-indigo-600 focus:ring-offset-0 focus:ring-0" checked onclick="toggleSection('edit-page-type', false); revealNext('q-has-text')" />
                                <span class="text-sm font-medium text-slate-700">Có</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-rose-100 hover:border-rose-300 transition-colors shadow-sm">
                                <input type="radio" name="q_page_type" value="no" class="text-rose-500 focus:ring-offset-0 focus:ring-0" onclick="toggleSection('edit-page-type', true); revealNext('q-has-text')" />
                                <span class="text-sm font-medium text-slate-700">Không</span>
                            </label>
                        </div>
                        
                        <div id="edit-page-type" class="hidden mt-2 p-3 bg-white rounded-lg border border-indigo-100 animate-fade-in">
                            <label class="block text-xs font-bold text-slate-500 mb-1">Chọn loại trang đúng:</label>
                             <select name="page_type" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5">
                                {PAGE_TYPES.map(t => (
                                    <option value={t} selected={dataRow.page_type === t}>{t.replace('_', ' ')}</option>
                                ))}
                            </select>
                        </div>
                    </div>
                </div>

                {/* 2. Has Text */}
                <div class="bg-slate-50 p-5 rounded-xl border border-slate-200 transition-all opacity-50 pointer-events-none question-block" id="q-has-text" data-next="q-has-table">
                     <div class="flex flex-col gap-3">
                        <div class="flex justify-between items-start">
                            <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wide">
                                2. Trang này có <span class="text-indigo-600">{dataRow.has_text ? 'CHỮ' : 'KHÔNG CÓ CHỮ'}</span>?
                            </h3>
                            <button type="button" class="skip-btn text-xs text-slate-400 hover:text-indigo-600 px-2 py-1 rounded hover:bg-indigo-50" onclick="skipQuestion('q-has-text', 'q-has-table')">Bỏ qua →</button>
                        </div>
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-slate-200 hover:border-indigo-300 transition-colors shadow-sm">
                                <input type="radio" name="q_has_text" value="yes" class="text-indigo-600 focus:ring-offset-0 focus:ring-0" checked onclick="toggleSection('edit-has-text', false); revealNext('q-has-table')" />
                                <span class="text-sm font-medium text-slate-700">Có</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-slate-200 hover:border-rose-300 transition-colors shadow-sm">
                                <input type="radio" name="q_has_text" value="no" class="text-rose-500 focus:ring-offset-0 focus:ring-0" onclick="toggleSection('edit-has-text', true); revealNext('q-has-table')" />
                                <span class="text-sm font-medium text-slate-700">Không</span>
                            </label>
                        </div>

                         <div id="edit-has-text" class="hidden mt-2 p-3 bg-white rounded-lg border border-slate-200 animate-fade-in">
                             <label class="block text-xs font-bold text-slate-500 mb-1">Chọn lại:</label>
                             <select name="has_text" class="w-full border text-sm rounded-lg block p-2.5 bg-slate-50 border-slate-300 text-slate-900">
                                 <option value="true" selected={dataRow.has_text}>Có chữ</option>
                                 <option value="false" selected={!dataRow.has_text}>Không có chữ</option>
                            </select>
                         </div>
                     </div>
                </div>

                {/* 3. Has Table */}
                <div class="bg-slate-50 p-5 rounded-xl border border-slate-200 transition-all opacity-50 pointer-events-none question-block" id="q-has-table" data-next="q-objects">
                     <div class="flex flex-col gap-3">
                        <div class="flex justify-between items-start">
                            <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wide">
                                3. Trang này có <span class="text-indigo-600">{dataRow.has_table ? 'BẢNG' : 'KHÔNG CÓ BẢNG'}</span>?
                            </h3>
                            <button type="button" class="skip-btn text-xs text-slate-400 hover:text-indigo-600 px-2 py-1 rounded hover:bg-indigo-50" onclick="skipQuestion('q-has-table', 'q-objects')">Bỏ qua →</button>
                        </div>
                         <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-slate-200 hover:border-indigo-300 transition-colors shadow-sm">
                                <input type="radio" name="q_has_table" value="yes" class="text-indigo-600 focus:ring-offset-0 focus:ring-0" checked onclick="toggleSection('edit-has-table', false); revealNext('q-objects')" />
                                <span class="text-sm font-medium text-slate-700">Có</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-slate-200 hover:border-rose-300 transition-colors shadow-sm">
                                <input type="radio" name="q_has_table" value="no" class="text-rose-500 focus:ring-offset-0 focus:ring-0" onclick="toggleSection('edit-has-table', true); revealNext('q-objects')" />
                                <span class="text-sm font-medium text-slate-700">Không</span>
                            </label>
                        </div>
                        <div id="edit-has-table" class="hidden mt-2 p-3 bg-white rounded-lg border border-slate-200 animate-fade-in">
                             <label class="block text-xs font-bold text-slate-500 mb-1">Chọn lại:</label>
                             <select name="has_table" class="w-full border text-sm rounded-lg block p-2.5 bg-slate-50 border-slate-300 text-slate-900">
                                 <option value="true" selected={dataRow.has_table}>Có bảng</option>
                                 <option value="false" selected={!dataRow.has_table}>Không có bảng</option>
                            </select>
                         </div>
                     </div>
                </div>

                {/* 4. Objects Present */}
                <div class="bg-slate-50 p-5 rounded-xl border border-slate-200 transition-all opacity-50 pointer-events-none question-block" id="q-objects" data-next="q-verify">
                   <div class="flex flex-col gap-3">
                       <div class="flex justify-between items-start">
                           <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wide">
                               4. Các đối tượng sau có xuất hiện?
                           </h3>
                           <button type="button" class="skip-btn text-xs text-slate-400 hover:text-indigo-600 px-2 py-1 rounded hover:bg-indigo-50" onclick="skipQuestion('q-objects', 'q-verify')">Bỏ qua →</button>
                       </div>
                       <div class="flex flex-wrap gap-2 text-xs font-medium text-slate-600 bg-white p-3 rounded-lg border border-slate-200">
                            {dataRow.objects_present && dataRow.objects_present.length > 0 ? (
                                dataRow.objects_present.map((obj: string) => (<span class="px-2 py-1 bg-indigo-50 text-indigo-700 rounded border border-indigo-100">{obj.replace('_',' ')}</span>))
                            ) : "Không có đối tượng"}
                       </div>
                       
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-slate-200 hover:border-indigo-300 transition-colors shadow-sm">
                                <input type="radio" name="q_objects" value="yes" class="text-indigo-600 focus:ring-offset-0 focus:ring-0" checked onclick="toggleSection('edit-objects', false); revealNext('q-verify')" />
                                <span class="text-sm font-medium text-slate-700">Có</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-slate-200 hover:border-rose-300 transition-colors shadow-sm">
                                <input type="radio" name="q_objects" value="no" class="text-rose-500 focus:ring-offset-0 focus:ring-0" onclick="toggleSection('edit-objects', true); revealNext('q-verify')" />
                                <span class="text-sm font-medium text-slate-700">Không</span>
                            </label>
                        </div>
                   </div>

                   <div id="edit-objects" class="hidden mt-4 pt-4 border-t border-slate-200">
                       <label class="block text-xs font-bold text-slate-900 uppercase tracking-wider mb-2">Chọn đối tượng thực tế:</label>
                       <div class="grid grid-cols-2 gap-y-2 gap-x-4 max-h-60 overflow-y-auto custom-scrollbar pr-2">
                           {OBJECTS_PRESENT_ENUM.map((obj: string) => (
                               <label class="flex items-center space-x-2 cursor-pointer p-1.5 hover:bg-white rounded transition-colors duration-150">
                                   <input type="checkbox" name="objects_present" value={obj} checked={dataRow.objects_present && dataRow.objects_present.includes(obj)} class="rounded border-slate-300 text-indigo-600 shadow-sm focus:ring-offset-0 focus:ring-0 w-4 h-4" />
                                   <span class="text-xs text-slate-600 font-medium">{obj.replace('_', ' ')}</span>
                               </label>
                           ))}
                       </div>
                   </div>
                </div>

                {/* 5. Detailed Verification */}
                <div class="space-y-6 pt-6 border-t border-slate-100 opacity-50 pointer-events-none transition-all" id="q-verify">
                     <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider">
                        Kiểm tra nội dung
                    </h3>
                    
                    {/* Common Questions */}
                    <div class="bg-white rounded-xl border border-slate-200 p-4 space-y-4">
                        <h4 class="text-sm font-bold text-slate-800 border-b border-slate-100 pb-2">Kiểm tra chung</h4>
                        
                        {/* Question 5.1 */}
                        <div>
                             <p class="text-sm text-slate-700 mb-2">Trang này có bị đánh sai tên không?</p>
                             <div class="flex gap-4">
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_1" value="no" checked onclick="toggleSection('err-q-v-1', false); checkChangeLog()" class="text-indigo-600 focus:ring-0"/> Không</label>
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_1" value="yes" onclick="toggleSection('err-q-v-1', true); checkChangeLog()" class="text-rose-500 focus:ring-0"/> Có</label>
                             </div>
                             <div id="err-q-v-1" class="hidden mt-2 ml-4 space-y-2 border-l-2 border-rose-200 pl-3">
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="ID_ISSUE" checked={dataRow.error_tags?.includes("ID_ISSUE")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">ID Issue</span></label>
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="IMAGE_MISMATCH" checked={dataRow.error_tags?.includes("IMAGE_MISMATCH")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Image Mismatch</span></label>
                             </div>
                        </div>
                        {/* Question 5.2 */}
                        <div>
                             <p class="text-sm text-slate-700 mb-2">Có suy luận đạo đức / giáo dục không?</p>
                             <div class="flex gap-4">
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_2" value="no" checked onclick="toggleSection('err-q-v-2', false); checkChangeLog()" class="text-indigo-600 focus:ring-0"/> Không</label>
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_2" value="yes" onclick="toggleSection('err-q-v-2', true); checkChangeLog()" class="text-rose-500 focus:ring-0"/> Có</label>
                             </div>
                             <div id="err-q-v-2" class="hidden mt-2 ml-4 border-l-2 border-rose-200 pl-3">
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="SUBJECTIVE_REASONING" checked={dataRow.error_tags?.includes("SUBJECTIVE_REASONING")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Subjective Reasoning</span></label>
                             </div>
                        </div>
                         {/* Question 5.3 */}
                         <div>
                             <p class="text-sm text-slate-700 mb-2">Có chi tiết bịa đặt không có trong ảnh không?</p>
                             <div class="flex gap-4">
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_3" value="no" checked onclick="toggleSection('err-q-v-3', false); checkChangeLog()" class="text-indigo-600 focus:ring-0"/> Không</label>
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_3" value="yes" onclick="toggleSection('err-q-v-3', true); checkChangeLog()" class="text-rose-500 focus:ring-0"/> Có</label>
                             </div>
                             <div id="err-q-v-3" class="hidden mt-2 ml-4 border-l-2 border-rose-200 pl-3">
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="HALLUCINATION" checked={dataRow.error_tags?.includes("HALLUCINATION")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Hallucination</span></label>
                             </div>
                        </div>
                         {/* Question 5.4 */}
                         <div>
                             <p class="text-sm text-slate-700 mb-2">Thứ tự có không hợp lý hay nhảy ý khó nghe không?</p>
                             <div class="flex gap-4">
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_4" value="no" checked onclick="toggleSection('err-q-v-4', false); checkChangeLog()" class="text-indigo-600 focus:ring-0"/> Không</label>
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_4" value="yes" onclick="toggleSection('err-q-v-4', true); checkChangeLog()" class="text-rose-500 focus:ring-0"/> Có</label>
                             </div>
                             <div id="err-q-v-4" class="hidden mt-2 ml-4 border-l-2 border-rose-200 pl-3">
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="DETAIL_INCOHERENT_FLOW" checked={dataRow.error_tags?.includes("DETAIL_INCOHERENT_FLOW")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Incoherent Flow</span></label>
                             </div>
                        </div>
                    </div>

                    {/* Cursor Short Specific */}
                     <div class="bg-white rounded-xl border border-slate-200 p-4 space-y-4">
                        <h4 class="text-sm font-bold text-slate-800 border-b border-slate-100 pb-2">Caption Short</h4>
                        
                         {/* Question 5.5 */}
                         <div>
                             <p class="text-sm text-slate-700 mb-2">Caption short có nằm ngoài 1-2 câu hay mô tả không đúng loại trang không?</p>
                              <div class="flex gap-4">
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_5" value="no" checked onclick="toggleSection('err-q-v-5', false); checkChangeLog()" class="text-indigo-600 focus:ring-0"/> Không</label>
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_5" value="yes" onclick="toggleSection('err-q-v-5', true); checkChangeLog()" class="text-rose-500 focus:ring-0"/> Có</label>
                             </div>
                             <div id="err-q-v-5" class="hidden mt-2 ml-4 space-y-2 border-l-2 border-rose-200 pl-3">
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="TOO_LONG_SHORT" checked={dataRow.error_tags?.includes("TOO_LONG_SHORT")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Too Long/Short</span></label>
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="MISQUOTED_TEXT" checked={dataRow.error_tags?.includes("MISQUOTED_TEXT")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Misquoted/Wrong Type</span></label>
                             </div>
                         </div>
                         
                          {/* Question 5.6 */}
                         <div>
                             <p class="text-sm text-slate-700 mb-2">Có dán OCR dài hay liệt kê quá chi tiết không?</p>
                              <div class="flex gap-4">
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_6" value="no" checked onclick="toggleSection('err-q-v-6', false); checkChangeLog()" class="text-indigo-600 focus:ring-0"/> Không</label>
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_6" value="yes" onclick="toggleSection('err-q-v-6', true); checkChangeLog()" class="text-rose-500 focus:ring-0"/> Có</label>
                             </div>
                             <div id="err-q-v-6" class="hidden mt-2 ml-4 border-l-2 border-rose-200 pl-3">
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="TOO_LONG_SHORT" checked={dataRow.error_tags?.includes("TOO_LONG_SHORT")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Too Detailed/OCR Dump</span></label>
                             </div>
                         </div>
                     </div>

                    {/* Caption Detail Specific */}
                     <div class="bg-white rounded-xl border border-slate-200 p-4 space-y-4">
                        <h4 class="text-sm font-bold text-slate-800 border-b border-slate-100 pb-2">Caption Detail</h4>
                        
                         {/* Question 5.7 */}
                         <div>
                             <p class="text-sm text-slate-700 mb-2">Tổng quan trang có đi sau chi tiết không?</p>
                             <div class="flex gap-4">
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_7" value="no" checked onclick="toggleSection('err-q-v-7', false); checkChangeLog()" class="text-indigo-600 focus:ring-0"/> Không</label>
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_7" value="yes" onclick="toggleSection('err-q-v-7', true); checkChangeLog()" class="text-rose-500 focus:ring-0"/> Có</label>
                             </div>
                             <div id="err-q-v-7" class="hidden mt-2 ml-4 border-l-2 border-rose-200 pl-3">
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="WRONG_LAYOUT" checked={dataRow.error_tags?.includes("WRONG_LAYOUT")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Wrong Layout (Overview Last)</span></label>
                             </div>
                         </div>

                          {/* Question 5.8 */}
                         <div>
                             <p class="text-sm text-slate-700 mb-2">Chữ trong ảnh minh họa có dẫn sai ngữ cảnh hoặc trái nguyên văn không?</p>
                             <div class="flex gap-4">
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_8" value="no" checked onclick="toggleSection('err-q-v-8', false); checkChangeLog()" class="text-indigo-600 focus:ring-0"/> Không</label>
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_8" value="yes" onclick="toggleSection('err-q-v-8', true); checkChangeLog()" class="text-rose-500 focus:ring-0"/> Có</label>
                             </div>
                             <div id="err-q-v-8" class="hidden mt-2 ml-4 grid grid-cols-2 gap-2 border-l-2 border-rose-200 pl-3">
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="MISQUOTED_TEXT" checked={dataRow.error_tags?.includes("MISQUOTED_TEXT")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Misquoted</span></label>
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="OCR_MISSING" checked={dataRow.error_tags?.includes("OCR_MISSING")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">OCR Missing</span></label>
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="OCR_WRONG" checked={dataRow.error_tags?.includes("OCR_WRONG")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">OCR Wrong</span></label>
                                  <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="OCR_NOT_CONTEXTUALIZED" checked={dataRow.error_tags?.includes("OCR_NOT_CONTEXTUALIZED")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Not Contextualized</span></label>
                                   <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="OCR_UNREADABLE" checked={dataRow.error_tags?.includes("OCR_UNREADABLE")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Unreadable</span></label>
                             </div>
                         </div>

                          {/* Question 5.9 */}
                         <div>
                             <p class="text-sm text-slate-700 mb-2">Thuyết minh có sai luồng_đọc(trên -> dưới, trái phải) hay làm người nghe không định vị được vị trí thuộc phần nào không?</p>
                             <div class="flex gap-4">
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_9" value="no" checked onclick="toggleSection('err-q-v-9', false); checkChangeLog()" class="text-indigo-600 focus:ring-0"/> Không</label>
                               <label class="radio-btn gap-2"><input type="radio" name="q_v_9" value="yes" onclick="toggleSection('err-q-v-9', true); checkChangeLog()" class="text-rose-500 focus:ring-0"/> Có</label>
                             </div>
                             <div id="err-q-v-9" class="hidden mt-2 ml-4 space-y-2 border-l-2 border-rose-200 pl-3">
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="WRONG_LAYOUT" checked={dataRow.error_tags?.includes("WRONG_LAYOUT")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Wrong Layout/Flow</span></label>
                                 <label class="flex items-center gap-2"><input type="checkbox" name="error_tags" value="DETAIL_INCOHERENT_FLOW" checked={dataRow.error_tags?.includes("DETAIL_INCOHERENT_FLOW")} class="text-rose-500 rounded border-slate-300" onchange="checkChangeLog()"/> <span class="text-xs">Incoherent Flow</span></label>
                             </div>
                         </div>
                     </div>
                </div>

                {/* Final Check Display / Manual Override */}
                <div class="bg-rose-50 p-4 rounded-xl border border-rose-100">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-xs font-bold text-rose-800 uppercase">Lỗi phát hiện (Chỉnh sửa thủ công)</h4>
                         <button type="button" onclick="document.getElementById('manual-error-tags').classList.toggle('hidden')" class="text-xs text-rose-600 hover:text-rose-800 underline">Hiển tất cả tag</button>
                    </div>
                     <div class="flex flex-wrap gap-2 mb-2" id="error-tags-display">
                        {/* Summary of checked tags (for display) */}
                        {dataRow.error_tags?.map((t) => (
                            <span class="px-2 py-1 bg-rose-100 text-rose-700 rounded text-xs border border-rose-200 font-mono">{t}</span>
                        ))}
                         {!dataRow.error_tags?.length && <span class="text-xs text-rose-400 italic">Không có lỗi</span>}
                     </div>

                    <div id="manual-error-tags" class="hidden mt-3 pt-3 border-t border-rose-200 grid grid-cols-2 gap-2">
                         {ERROR_TAGS.map((tag) => (
                             <label class="flex items-center space-x-2 cursor-pointer p-1 hover:bg-rose-100 rounded">
                                 <input
                                   type="checkbox"
                                   name="error_tags"
                                   value={tag}
                                   checked={dataRow.error_tags && dataRow.error_tags.includes(tag)}
                                   class="rounded border-rose-300 text-rose-600 shadow-sm focus:ring-0 w-3.5 h-3.5"
                                   onchange="checkChangeLog()"
                                 />
                                 <span class="text-xs text-rose-800 font-mono font-medium">{tag}</span>
                             </label>
                         ))}
                    </div>
                </div>

              </div>

              {/* Requirement 6: Auto Flags Verification */}
               <div class="space-y-4 pt-6 border-t border-slate-100">
                  <div class="bg-amber-50 rounded-xl border border-amber-200 p-4">
                      <h4 class="text-sm font-bold text-amber-800 border-b border-amber-100 pb-2 mb-3 tracking-wide uppercase">Cờ tự động phát hiện</h4>
                      
                      <div class="mb-4 text-xs font-mono text-amber-900 bg-white/50 p-2 rounded">
                          {dataRow.auto_flags && dataRow.auto_flags.length > 0 ? dataRow.auto_flags.join(', ') : "Không có"}
                      </div>

                       <div>
                           <p class="text-sm text-slate-700 mb-2 font-medium">Các cờ tự động này có đúng không?</p>
                           <div class="flex gap-4 mb-3">
                                <label class="radio-btn gap-2"><input type="radio" name="q_auto_flags" value="yes" checked onclick="toggleSection('edit-auto-flags', false)" class="text-indigo-600 focus:ring-0"/> Có</label>
                                <label class="radio-btn gap-2"><input type="radio" name="q_auto_flags" value="no" onclick="toggleSection('edit-auto-flags', true)" class="text-rose-500 focus:ring-0"/> Không (Sửa)</label>
                           </div>
                           
                           <div id="edit-auto-flags" class="hidden mt-2 p-3 bg-white rounded-lg border border-amber-200">
                               <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Chọn cờ thực tế:</label>
                                <div class="grid grid-cols-2 gap-2">
                                   {AUTO_FLAGS.map((msg) => (
                                     <label class="flex items-center space-x-2 cursor-pointer">
                                       <input
                                         type="checkbox"
                                         name="auto_flags"
                                         value={msg}
                                         checked={dataRow.auto_flags && dataRow.auto_flags.includes(msg)}
                                         class="rounded border-slate-300 text-amber-600 shadow-sm focus:ring-0 w-3.5 h-3.5"
                                         onchange="checkChangeLog()"
                                       />
                                       <span class="text-xs text-slate-700 font-mono font-medium">{msg}</span>
                                     </label>
                                   ))}
                                 </div>
                           </div>
                       </div>
                  </div>
              </div>

              {/* Notes & Changelog */}
              <div class="space-y-4 pt-6 border-t border-slate-100">
                  <div>
                      <h4 class="text-sm font-bold text-slate-800 mb-2">Ghi chú này có chính xác không?</h4>
                      <div class="flex items-center gap-4 mb-2">
                           <button type="button" onclick="document.getElementById('notes-edit-area').classList.remove('hidden'); document.getElementById('changelog_container').classList.remove('hidden');" class="px-3 py-1.5 text-xs bg-white border border-slate-200 text-slate-600 rounded hover:border-amber-400 hover:text-amber-600">Không, sửa ghi chú</button>
                           {dataRow.notes ? (
                               <p class="text-sm text-slate-600 italic">"{dataRow.notes}"</p>
                           ) : (
                               <p class="text-sm text-slate-400 italic">Không có ghi chú</p>
                           )}
                      </div>
                      <div id="notes-edit-area" class="hidden animate-fade-in">
                          <textarea name="notes" rows="2" class="w-full text-sm border-amber-200 rounded-lg p-2.5 focus:ring-amber-500 focus:border-amber-500 bg-amber-50" placeholder="Nhập ghi chú..." oninput="document.getElementById('changelog_container').classList.remove('hidden')">{dataRow.notes || ""}</textarea>
                      </div>
                  </div>
                   <div id="changelog_container" class="hidden animate-fade-in">
                      <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nhật ký thay đổi</label>
                      <input type="text" name="change_log" class="w-full text-sm border-indigo-200 rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500 bg-indigo-50/50" placeholder="Giải thích đã thay đổi gì..." />
                  </div>
              </div>

              <div class="sticky bottom-0 bg-white pt-4 pb-2 border-t border-slate-100 -mx-8 px-8 z-30 flex flex-col gap-3">
                {/* Sequential Navigation */}
                {viewMode === "sequential" && (
                  <div class="flex items-center justify-between gap-2">
                    <a
                      id="prev-btn"
                      href={prevId ? `/?search_id=${prevId}&mode=sequential&filter_is_checked=${filterIsChecked}${filterPriority ? `&filter_priority=${filterPriority}` : ''}` : '#'}
                      class={`flex items-center gap-1 px-3 py-2 text-sm font-medium rounded-lg transition-all ${prevId ? 'text-slate-600 hover:bg-slate-100' : 'text-slate-300 pointer-events-none'}`}
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                      Trước (←)
                    </a>
                    <span class="text-sm text-slate-500 font-medium">
                      {currentIndex} / {sequentialTotal}
                    </span>
                    <a
                      id="next-btn"
                      href={nextId ? `/?search_id=${nextId}&mode=sequential&filter_is_checked=${filterIsChecked}${filterPriority ? `&filter_priority=${filterPriority}` : ''}` : '#'}
                      class={`flex items-center gap-1 px-3 py-2 text-sm font-medium rounded-lg transition-all ${nextId ? 'text-slate-600 hover:bg-slate-100' : 'text-slate-300 pointer-events-none'}`}
                    >
                      Sau (→)
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </a>
                  </div>
                )}
                
                <div class="flex gap-4">
                  <button
                    id="save-btn"
                    type="submit"
                    disabled={isSaved}
                    class={`flex-1 flex justify-center items-center gap-2 py-3.5 px-4 border border-transparent rounded-xl shadow-lg text-sm font-bold text-white transition-all ${isSaved ? 'bg-slate-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700'}`}
                  >
                    <svg id="save-spinner" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="save-btn-text">{isSaved ? 'Đã lưu!' : 'Lưu (Ctrl+S)'}</span>
                  </button>
                   <a
                    href={viewMode === "sequential" && nextId ? `/?search_id=${nextId}&mode=sequential&filter_is_checked=${filterIsChecked}${filterPriority ? `&filter_priority=${filterPriority}` : ''}` : "/"}
                    id="continue-btn"
                    class={`flex-1 flex justify-center items-center py-3.5 px-4 border border-indigo-200 bg-white text-indigo-700 rounded-xl shadow-sm text-sm font-bold transition-all ${isSaved ? 'hover:bg-indigo-50' : 'pointer-events-none opacity-50'}`}
                  >
                    Tiếp tục (Enter)
                  </a>
                </div>
              </div>
            </form>
          </div>
        </div>
      ) : (
        <div class="flex items-center justify-center flex-col h-full text-slate-400 text-sm space-y-4">
          <p>Không còn mục nào cho bộ lọc này.</p>
          <button
            onclick="document.cookie='dataset_filter=; Max-Age=0; path=/'; window.location.reload()"
            class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors"
          >
            Xóa bộ lọc & Thử lại
          </button>
        </div>
      )
    }
    <script is:inline>
      // Form submit loading state and initialization
      function initFormHandlers() {
        const form = document.getElementById('main-form');
        const saveBtn = document.getElementById('save-btn');
        const saveBtnText = document.getElementById('save-btn-text');
        const saveSpinner = document.getElementById('save-spinner');
        
        // Check if this page was just saved (from URL param)
        const urlParams = new URLSearchParams(window.location.search);
        const isSaved = urlParams.get('saved') === 'true';
        
        if (saveBtn && saveBtnText && saveSpinner) {
          // Reset button to correct state based on URL
          if (isSaved) {
            saveBtn.disabled = true;
            saveBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'bg-indigo-400', 'cursor-wait');
            saveBtn.classList.add('bg-slate-400', 'cursor-not-allowed');
            saveBtnText.textContent = 'Đã lưu!';
            saveSpinner.classList.add('hidden');
          } else {
            saveBtn.disabled = false;
            saveBtn.classList.remove('bg-slate-400', 'cursor-not-allowed', 'bg-indigo-400', 'cursor-wait');
            saveBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            saveBtnText.textContent = 'Lưu (Ctrl+S)';
            saveSpinner.classList.add('hidden');
          }
        }
        
        if (form && saveBtn) {
          form.addEventListener('submit', (e) => {
            // Show loading state
            saveBtn.disabled = true;
            saveBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            saveBtn.classList.add('bg-indigo-400', 'cursor-wait');
            if (saveBtnText) saveBtnText.textContent = 'Đang lưu...';
            if (saveSpinner) saveSpinner.classList.remove('hidden');
          });
        }
      }
      
      // Run on initial load
      initFormHandlers();
      
      // Re-run after View Transitions navigation
      document.addEventListener('astro:page-load', initFormHandlers);

      // New Logic for Questionnaire
      function toggleSection(id, show) {
        const el = document.getElementById(id);
        if(!el) return;
        if (show) {
          el.classList.remove("hidden");
        } else {
          el.classList.add("hidden");
        }
      }

      function revealNext(id) {
          const el = document.getElementById(id);
          if(!el) return;
          el.classList.remove('opacity-50', 'pointer-events-none');
      }

      // Skip question function
      function skipQuestion(currentId, nextId) {
          revealNext(nextId);
          const nextEl = document.getElementById(nextId);
          if (nextEl) {
              nextEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
      }

      // Get current active question
      function getCurrentQuestion() {
          const questions = document.querySelectorAll('.question-block');
          for (const q of questions) {
              if (!q.classList.contains('opacity-50') && !q.classList.contains('pointer-events-none')) {
                  const rect = q.getBoundingClientRect();
                  if (rect.top >= 0 && rect.top < window.innerHeight / 2) {
                      return q;
                  }
              }
          }
          // Return first non-disabled question
          for (const q of questions) {
              if (!q.classList.contains('opacity-50')) {
                  return q;
              }
          }
          return null;
      }

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
          // Skip if user is typing in input/textarea
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
              // Allow Ctrl+S for save
              if (e.ctrlKey && e.key === 's') {
                  e.preventDefault();
                  const saveBtn = document.getElementById('save-btn');
                  if (saveBtn && !saveBtn.disabled) saveBtn.click();
              }
              return;
          }

          const currentQ = getCurrentQuestion();
          
          // C = Có (Yes)
          if (e.key === 'c' || e.key === 'C') {
              if (currentQ) {
                  const yesRadio = currentQ.querySelector('input[type="radio"][value="yes"]');
                  if (yesRadio) {
                      yesRadio.click();
                      yesRadio.focus();
                  }
              }
          }
          
          // K = Không (No)
          if (e.key === 'k' || e.key === 'K') {
              if (currentQ) {
                  const noRadio = currentQ.querySelector('input[type="radio"][value="no"]');
                  if (noRadio) {
                      noRadio.click();
                      noRadio.focus();
                  }
              }
          }
          
          // S = Skip
          if (e.key === 's' || e.key === 'S') {
              if (currentQ) {
                  const skipBtn = currentQ.querySelector('.skip-btn');
                  if (skipBtn) skipBtn.click();
              }
          }

          // Ctrl+S = Save
          if (e.ctrlKey && e.key === 's') {
              e.preventDefault();
              const saveBtn = document.getElementById('save-btn');
              if (saveBtn && !saveBtn.disabled) saveBtn.click();
          }

          // Enter = Continue (if saved)
          if (e.key === 'Enter' && !e.ctrlKey && !e.shiftKey) {
              const continueBtn = document.getElementById('continue-btn');
              if (continueBtn && !continueBtn.classList.contains('pointer-events-none')) {
                  window.location.href = continueBtn.href;
              }
          }

          // ArrowLeft = Previous (in sequential mode)
          if (e.key === 'ArrowLeft') {
              const prevBtn = document.getElementById('prev-btn');
              if (prevBtn && !prevBtn.classList.contains('pointer-events-none')) {
                  window.location.href = prevBtn.href;
              }
          }

          // ArrowRight = Next (in sequential mode)
          if (e.key === 'ArrowRight') {
              const nextBtn = document.getElementById('next-btn');
              if (nextBtn && !nextBtn.classList.contains('pointer-events-none')) {
                  window.location.href = nextBtn.href;
              }
          }
      });

      function toggleEditCaption(inputId, btnId) {
          const input = document.getElementById(inputId);
          const btn = document.getElementById(btnId);
          const btnText = btn.querySelector('.btn-text');
          
          if(input.readOnly) {
              // Switch to Edit Mode
              input.readOnly = false;
              input.focus();
              btnText.innerText = "Save";
              btn.classList.remove('opacity-70');
              btn.classList.add('bg-indigo-500', 'text-white');
          } else {
              // Switch to Saved Mode (Lock)
              input.readOnly = true;
              btnText.innerText = "Edit";
              btn.classList.add('opacity-70');
              btn.classList.remove('bg-indigo-500', 'text-white');
              // Trigger changelog if needed
              checkChangeLog();
          }
      }

      // Populate Final Summary based on checkboxes
      function updateFinalSummary() {
          const summaryContainer = document.getElementById('error-tags-display');
          
          // Get all checked error tags from both Wizard (generated issues) and Manual Override
          const checkboxes = document.querySelectorAll('input[name="error_tags"]:checked');
          const uniqueTags = new Set();
          checkboxes.forEach(cb => uniqueTags.add(cb.value));
          
          summaryContainer.innerHTML = '';
          if(uniqueTags.size > 0) {
              uniqueTags.forEach(tag => {
                  const span = document.createElement('span');
                  span.className = "px-2 py-1 bg-rose-100 text-rose-700 rounded text-xs border border-rose-200 font-mono";
                  span.innerText = tag;
                  summaryContainer.appendChild(span);
              });
          } else {
              const span = document.createElement('span');
              span.className = "text-xs text-rose-400 italic";
              span.innerText = "No issues flagged";
              summaryContainer.appendChild(span);
          }
      }

      function checkChangeLog() {
        // Run final summary update too
        updateFinalSummary();

        const cl = document.getElementById("changelog_container");
        
        // 1. Check if any "edit" section hidden inputs are showing? 
        // Not reliable, better to check if any "No" radio is checked.
        // We use querySelectorAll for all radios with value 'no' or 'yes' that trigger changes.
        // But specifically, we want to know if *Data* Changed.
        
        let changed = false;

        // Check verification "Yes" answers (value="yes" means error present in our q_v_* logic)
        const verifYes = document.querySelectorAll('input[name^="q_v_"][value="yes"]:checked');
        if (verifYes.length > 0) changed = true;

        // Check classification "No" answers (value="no" means override needed)
        const classNo = document.querySelectorAll('input[name^="q_page_type"][value="no"]:checked, input[name^="q_has_"][value="no"]:checked, input[name^="q_objects"][value="no"]:checked');
        if (classNo.length > 0) changed = true;
        
        // Check manual edits in Note/Captions
        const noteArea = document.getElementById('notes-edit-area');
        if (noteArea && !noteArea.classList.contains('hidden')) changed = true;
        
        if (changed) {
             cl.classList.remove("hidden");
        } else {
             cl.classList.add("hidden");
        }
      }

      // Attach global listeners
      document.addEventListener("change", (e) => {
         if(e.target.name === 'error_tags') {
             updateFinalSummary();
         }
         checkChangeLog();
      });

      // Initial run
      updateFinalSummary();
      
      document.addEventListener("DOMContentLoaded", () => {
         // Initialize states based on checked boxes
         document.querySelectorAll('input[name="error_tags"]:checked').forEach(cb => {
            // Find parent error container
            const errDiv = cb.closest('div[id^="err-q-v-"]');
            if(errDiv) {
                // Reveal it
                errDiv.classList.remove('hidden');
                // Set corresponding radio to Yes
                const qName = 'q' + errDiv.id.substring(3).replace(/-/g, '_'); // err-q-v-1 -> q_v_1? No. id is err-q-v-1. name is q_v_1.
                // substring(4) of 'err-q-v-1' is 'q-v-1'. replace - with _ -> q_v_1.
                // Wait, id is "err-q-v-1". 
                // name is "q_v_1".
                // Logic: 
                const nameParts = errDiv.id.split('-'); // ['err', 'q', 'v', '1']
                // name should be q_v_1
                const radioName = nameParts.slice(1).join('_');
                const yesRadio = document.querySelector(`input[name="${radioName}"][value="yes"]`);
                if(yesRadio) yesRadio.checked = true;
            }
         });
         
         updateFinalSummary();
         checkChangeLog();
      });

      // Filter Logic (Keep existing)

      // --- Scope Logic (Cookie) ---
      function initScopeLogic() {
        const scopeBtn = document.getElementById("scope-btn");
        const scopeModal = document.getElementById("scope-modal");
        const closeScope = document.getElementById("close-scope");
        const applyScope = document.getElementById("apply-scope");
        const selectAll = document.getElementById("select-all");
        const clearAll = document.getElementById("clear-all");

        if (scopeBtn && scopeModal) {
          scopeBtn.addEventListener("click", () => scopeModal.classList.remove("hidden"));
          if (closeScope) closeScope.addEventListener("click", () => scopeModal.classList.add("hidden"));

          if (selectAll) {
            selectAll.addEventListener("click", () => {
              document.querySelectorAll('input[name="prefix_filter"]').forEach((cb) => (cb.checked = true));
            });
          }

          if (clearAll) {
            clearAll.addEventListener("click", () => {
              document.querySelectorAll('input[name="prefix_filter"]').forEach((cb) => (cb.checked = false));
            });
          }

          if (applyScope) {
            applyScope.addEventListener("click", () => {
              const selected = Array.from(
                document.querySelectorAll('input[name="prefix_filter"]:checked'),
              ).map((cb) => cb.value);
              const d = new Date();
              d.setTime(d.getTime() + 365 * 24 * 60 * 60 * 1000);
              document.cookie = `dataset_filter=${encodeURIComponent(JSON.stringify(selected))}; expires=${d.toUTCString()}; path=/`;
              window.location.reload();
            });
          }
        }
      }

      // --- Settings Logic (URL Params) ---
      function initSettingsLogic() {
        const settingsBtn = document.getElementById("settings-btn");
        const settingsModal = document.getElementById("settings-modal");
        const closeSettings = document.getElementById("close-settings");
        const applySettings = document.getElementById("apply-settings");

        if (settingsBtn && settingsModal) {
          settingsBtn.addEventListener("click", () => settingsModal.classList.remove("hidden"));
          if (closeSettings) closeSettings.addEventListener("click", () => settingsModal.classList.add("hidden"));

          if (applySettings) {
            applySettings.addEventListener("click", () => {
              const priority = document.getElementById("filter-priority").value;
              const isChecked = document.getElementById("filter-is-checked").value;
              const viewModeSelect = document.getElementById("view-mode");
              const mode = viewModeSelect ? viewModeSelect.value : "random";
              const url = new URL(window.location.href);
              
              // Update params
              if(priority) url.searchParams.set("filter_priority", priority);
              else url.searchParams.delete("filter_priority");
              
              if(isChecked && isChecked !== 'all') url.searchParams.set("filter_is_checked", isChecked);
              else url.searchParams.delete("filter_is_checked");
              
              // Set view mode
              if(mode === "sequential") {
                  url.searchParams.set("mode", "sequential");
              } else {
                  url.searchParams.delete("mode");
              }
              
              // If switching to sequential mode, clear search_id to start from beginning
              // If switching to random mode, clear search_id to get a new random item
              if(url.searchParams.get("mode") !== new URL(window.location.href).searchParams.get("mode")) {
                  url.searchParams.delete("search_id");
              }
              
              window.location.href = url.toString();
            });
          }
        }
      }

      // Close modals on outside click (only add once)
      function initModalCloseHandlers() {
        document.addEventListener("click", (e) => {
          const scopeBtn = document.getElementById("scope-btn");
          const scopeModal = document.getElementById("scope-modal");
          const settingsBtn = document.getElementById("settings-btn");
          const settingsModal = document.getElementById("settings-modal");
          
          if (scopeModal && scopeBtn && !scopeModal.contains(e.target) && !scopeBtn.contains(e.target)) {
            scopeModal.classList.add("hidden");
          }
          if (settingsModal && settingsBtn && !settingsModal.contains(e.target) && !settingsBtn.contains(e.target)) {
            settingsModal.classList.add("hidden");
          }
        });
      }

      // Initialize scope and settings
      initScopeLogic();
      initSettingsLogic();
      initModalCloseHandlers();
      
      // Re-run after View Transitions navigation
      document.addEventListener('astro:page-load', () => {
        initScopeLogic();
        initSettingsLogic();
      });

      // --- Resizable Panels Logic ---
      function initResizablePanels() {
        const mainContainer = document.getElementById('main-container');
        const leftPanel = document.getElementById('left-panel');
        const rightPanel = document.getElementById('right-panel');
        const handleH = document.getElementById('resize-handle-h');
        const captionPanel = document.getElementById('caption-panel');
        const handleV = document.getElementById('resize-handle-v');

        if (!mainContainer || !leftPanel || !handleH) return;

        let isResizingH = false;
        let isResizingV = false;

        // Load saved sizes from localStorage
        const savedLeftWidth = localStorage.getItem('panel-left-width');
        const savedCaptionHeight = localStorage.getItem('panel-caption-height');
        
        if (savedLeftWidth && leftPanel) {
          leftPanel.style.width = savedLeftWidth;
        }
        if (savedCaptionHeight && captionPanel) {
          captionPanel.style.height = savedCaptionHeight;
        }

        // Horizontal resize (left/right panels)
        handleH.addEventListener('mousedown', (e) => {
          isResizingH = true;
          handleH.classList.add('active');
          document.body.classList.add('no-select');
          document.body.style.cursor = 'col-resize';
          e.preventDefault();
        });

        // Vertical resize (caption/form panels)
        if (handleV && captionPanel) {
          handleV.addEventListener('mousedown', (e) => {
            isResizingV = true;
            handleV.classList.add('active');
            document.body.classList.add('no-select');
            document.body.style.cursor = 'row-resize';
            e.preventDefault();
          });
        }

        document.addEventListener('mousemove', (e) => {
          if (isResizingH) {
            const containerRect = mainContainer.getBoundingClientRect();
            const newWidth = e.clientX - containerRect.left;
            const containerWidth = containerRect.width;
            const minWidth = 250;
            const maxWidth = containerWidth - 400; // Leave space for right panel
            
            if (newWidth >= minWidth && newWidth <= maxWidth) {
              leftPanel.style.width = newWidth + 'px';
            }
          }
          
          if (isResizingV && captionPanel) {
            const rightPanelRect = rightPanel.getBoundingClientRect();
            const newHeight = e.clientY - rightPanelRect.top;
            const minHeight = 120;
            const maxHeight = rightPanelRect.height * 0.7;
            
            if (newHeight >= minHeight && newHeight <= maxHeight) {
              captionPanel.style.height = newHeight + 'px';
            }
          }
        });

        document.addEventListener('mouseup', () => {
          if (isResizingH) {
            isResizingH = false;
            handleH.classList.remove('active');
            document.body.classList.remove('no-select');
            document.body.style.cursor = '';
            // Save to localStorage
            localStorage.setItem('panel-left-width', leftPanel.style.width);
          }
          if (isResizingV) {
            isResizingV = false;
            handleV.classList.remove('active');
            document.body.classList.remove('no-select');
            document.body.style.cursor = '';
            // Save to localStorage
            if (captionPanel) {
              localStorage.setItem('panel-caption-height', captionPanel.style.height);
            }
          }
        });

        // Double-click to reset to default
        handleH.addEventListener('dblclick', () => {
          leftPanel.style.width = '41.67%';
          localStorage.removeItem('panel-left-width');
        });

        if (handleV) {
          handleV.addEventListener('dblclick', () => {
            captionPanel.style.height = '35%';
            localStorage.removeItem('panel-caption-height');
          });
        }
      }
      
      // Run on initial load
      initResizablePanels();
      
      // Re-run after View Transitions navigation
      document.addEventListener('astro:page-load', initResizablePanels);
    </script>
  </body>
</html>